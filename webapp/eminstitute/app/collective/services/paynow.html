#set($currency = '$' )
#set($id = $context.getRequestParameter('invoiceid'))
#set($invoice = $mediaarchive.getInvoiceById($id))
#set($products = $mediaarchive.getInvoiceProductList($id))
#set($workspace = $mediaarchive.getWorkspaceById($invoice.collectionid))
<div style="padding:20px">
<h1>[[Check Out]]</h1>
#if($mediaarchive.getCatalogSettingValue("productionmode") == "false")
<div class="alert alert-warning">Site is in test mode. Credit card is 4242 4242 4242 4242 any expiry. Add your keys to
    catalog settings and switch to production mode to take credit cards.</div>
#end

<div class="card">
    <div class="card-header">
        <div class="row" style="border-bottom:1px solidc ">
            <div class="col-sm-10">
                <h5>
                    <i class="fas fa-credit-card mr-4" style="font-size: 1.4em"></i>
                    [[All major Credit Cards Accepted]]
                </h5>
            </div>


        </div>
    </div>
    <div class="card-body" style="padding:20px 21px;">
        <div class="row">

            <div class="col-sm-8">
                <div class="card-body" style="padding: 20px;">
                    <h4>Products</h4>
                    <div class="table-responsive">
                        <table class="table">
                            <col span="1" style="width: 20%;">
                            <col span="1" style="width: 60%;">
                            <col span="1" style="width: 20%;">
                            <tr>
                                <th class="purchase_heading" align="left">
                                    <p class="f-fallback">Quantity</p>
                                </th>
                                <th class="purchase_heading" align="left">
                                    <p class="f-fallback">Description</p>
                                </th>
                                <th class="purchase_heading" align="right">
                                    <p class="f-fallback">Amount</p>
                                </th>
                            </tr>

                            #foreach ($product in $products)
                            <tr>
                                <td>$product.productquantity</td>
                                <td><span>$mediaarchive.getProductName($product.productid)</span></td>
                                <td><span>$currency $!context.roundDouble($product.productprice, 2)</span></td>
                            </tr>
                            #set($lastproduct = $mediaarchive.getProductById($product.productid))
                            #end
                            <tr>
                                <td class="text-right" colspan="2"><b>Total</b></td>
                                <td><b>$currency $!context.roundDouble($invoice.getValue("totalprice"), 2)</b></td>
                            </tr>
                        </table>
                    </div>
                </div>

            </div>
            <div class="col-sm-4">
                <div class="card donatecard">
                    <div class="card-block" style="padding: 20px 21px;">
                        <form action="$applink/collective/services/payfinish.html" method="post" id="payment-form"
                            class="form">
                            <input type="hidden" name="collectionid" value="$!librarycol.id" />
                            
                             #if ($workspace.savestripecreditcard == true && $customer.sources.data.size() > 0)
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label>[[Card Options]]:</label>
	                            	<select id="creditcardselect" class="form-control">
	                            		<option value="0">New Credit Card</option>
	                            		#foreach ($s in $customer.sources.data)
	                            		<option value="$s.id">$s.brand (****-$s.last4)</option>
	                            		#set( $custsource = $s.id )
	                            		#end
	                            	</select>
                            	</div>
                            </div>
							#end  
							<div id="allcreditcardform">	
							
	                            <div class="row">
	                                <div class="col">
	                                    <div class="float-right" style="margin-top:-4px"><img
	                                            src="$applink/theme/icons/creditcard.png" /></div>
	                                    <div class="form-group">
	                                        <label for="staticEmail">[[Card Info]]:</label>
	                                        
	                                                                              
	                                        
	                                        <div class="form-control">
	                                            <div id="card-element" style="width: 100%">
	                                            </div>
	                                        </div>
	                                    </div>
	                                </div>
	                                
	                            </div>
	
	                            <div class="row">
	                                <div class="col-md-6">
	                                    <div class="form-group">
	                                        <label for="staticEmail">[[Amount]]:</label>
	                                        <div class="input-group">
	                                            <div class="input-group-prepend">
	                                                <div class="input-group-text">$</div>
	                                            </div>
	                                            <input type="text" class="form-control" name="totalprice.value"
	                                                id="totalprice" #if($invoice.totalprice) value="$invoice.totalprice"
	                                                disabled #end>
	                                        </div>
	                                    </div>
	                                </div>
	
									#if ($lastproduct.recurring == true)
	                               <div class="col-md-6">	                               
			                            <div class="form-group">
			                                <label for="staticEmail">[[Recurring Monthly]]</label>                                 
			                                <input type="text" class="form-control" name="recurringperiod" value="$lastproduct.recurringperiod" disabled></input>
			                            </div>
	                        	   </div>
	                        		#end
	                        	  	<div class="col-md-12">
	                                	<div class="form-check">
			                                <input type="checkbox" class="form-check-input" id="issavecard" name="issavecard"></input>
			                                <label class="form-check-label" for="issavecard">[[Save this Credit Card for future payments]]</label>	
			                            </div>
	                               	</div>
	                        	   
	                            </div>
	 						</div>
                            <div class="row mt-2">                            	
                                <div class="col-md-6">
                                <div id="card-errors" class="donateformerror" role="alert"></div>
                                    <div class="donate-secure ">
                                        <i class="fas fa-lock"></i> [[Secure payment]]
                                    </div>
                                </div>
                                <div class="col-md-6 text-right">
                                    <div style=" margin: 0px auto;">
                                        <a href="#" onclick='$("#payment-form").submit()' class="btn btn-success"><i
                                                class="fas fa-credit-card"></i> [[Pay Now]] </a>
                                    </div>
                                </div>
                            </div>
							
							<input type="hidden" name="isautopaid" id="isautopaid" value="$lastproduct.isautopaid" />
							<input type="hidden" name="savestripecreditcard" id="savestripecreditcard" value="true" />
							<input type="hidden" name="recurring" value="$lastproduct.recurring" />
                            <input type="hidden" name="field" value="collectionid" /> 
                            <input type="hidden" name="collectionid.value" value="$librarycol.getId()" /> 
                            <input type="hidden" name="collectionid" value="$librarycol.getId()" />
                            <input type="hidden" name="invoiceid" value="$id" /> 
                            <input type="hidden" name="field" value="totalprice" /> 
                            <input type="hidden" name="field" value="userid" /> 
                            <input type="hidden" name="userid.value" value="$user.getId()" />
                            <input type="hidden" name="customerselected" id="customerselected" value="0" />
                            <input type="text" name="stripecustomer" id="stripecustomer" value="$customer.id" hidden="" />
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>


<script type="text/javascript">
	$("#issavecard").change(function() {  
	    if ($(this).is(":checked")) {
	    	document.getElementById('savestripecreditcard').value = true;
	    } else {
	    	document.getElementById('savestripecreditcard').value = false;
	    }
	});
	document.getElementById('issavecard').checked = true;
	
	#if ($workspace.savestripecreditcard == true && $customer.sources.data.size() > 0)
	let element = document.getElementById("creditcardselect");
	element.value = "0";

	$("#creditcardselect").change(function() {
		document.getElementById('customerselected').value = $("#creditcardselect").val() !== "0";
		$("#allcreditcardform").attr('hidden', $("#creditcardselect").val() !== "0");
	});
	#end
	
	
	
	document.getElementById('customerselected').value = false;
	
    $(document).ready(function () {
    	#if ($workspace.savestripecreditcard == true && $customer.sources.data.size() > 0)
	    	element.value = "$custsource";
		    $("#allcreditcardform").attr('hidden', $("#creditcardselect").val() !== "0");
		    document.getElementById("customerselected").value = "true";
		#end
	    
	  	  #if($mediaarchive.isCatalogSettingTrue("productionmode"))
        console.log('Production');
	  		#set($publishkey = $mediaarchive.getCatalogSettingValue("stripe_publishable_key"))
	  	 #else
        console.log('Test Publishkey');
	  		#set($publishkey = $mediaarchive.getCatalogSettingValue("stripe_test_publishable_key"))
	  	 #end
        var stripe = Stripe("$publishkey");
        var elements = stripe.elements();
        var style = { base: { fontSize: '18px', color: "#495057" } };

        // Create an instance of the card Element.
        var card = elements.create('card', { style: style });

        // Add an instance of the card Element into the `card-element` <div>
        card.mount('#card-element');

        // Handle real-time validation errors from the card Element.
        card.addEventListener('change', function (event) {
            var displayError = document.getElementById('card-errors');
            if (event.error) {
                $(displayError).html('<div class="errormsg">' + event.error.message + '</div>');
            } else {
                displayError.textContent = '';
            }
        });

        var form = document.getElementById('payment-form');
        $(form).validate({
            rules: {
                "totalprice.value": {
                    required: true,
                    number: true
                }
            },
            submitHandler: function (form) {
            	var isCustomer = document.getElementById("customerselected").value;
            	if (isCustomer != "true") {
	                stripe.createToken(card).then(function (result) {
	                    if (result.error) {
	                        var errorElement = document.getElementById('card-errors');
	                        $(errorElement).html('<div class="errormsg">' + result.error.message + '</div>');
	                    } else {
	                        stripeResponseHandler(result);
	                    }
                	});
            	} else {
            		form.submit();
            	}
            },
            errorElement: "div",
            errorClass: "errormsg",
            errorPlacement: function (error, element) {
                error.appendTo(element.closest(".form-group").parent());
                //$("#card-errors").html('<div class="errormsg">'+error.html()+'</div>');
            }
        });

        stripeResponseHandler = function (response) {
            var form = document.getElementById('payment-form');
            // var hiddenInput = document.createElement('input');
            hiddenInput = document.getElementById('stripecustomer');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'stripecustomer');
            hiddenInput.setAttribute('value', response.token.id);
            form.appendChild(hiddenInput);
            form.submit();
        }

    });
</script>