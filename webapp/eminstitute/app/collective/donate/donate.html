<div class="container">
<div class="contentcolumn">
	<h1>[[Donate to ]] $librarycol</h1>
	#if(!$user)
		<div style="padding:20px 0">
		#set($loginok =	"$applink/collective/donate/$!librarycol.id/donate.html")
		<i class="fas fa-credit-card"></i> [[Please Login to Donate with Credit Card or Paypal]] 
		<div style="padding:20px 0 10px;">
	  		<a href="$applink/authentication/logon.html?loginokpage=$!loginok"	class="btn btn-success">[[Login to Donate]]</a>
	  	</div>
	  	<div class="float-right">
	  		<img src="$applink/theme/icons/PayPal.svg" style="margin-right: 10px; height: 28px;" />
	  		<img src="$applink/theme/icons/creditcard.png" />
	  		
	  		</div>
	  	<div class="clearfix"></div>
	  	</div>
	#else
				
		#if( $caneditcollection) <a class="oe-dataedit showeditonright"
			data-target="#editdonatedescription-$librarycol.id"
			title="[[Edit Donation Description]]" data-width="500" href="#"><i
			class="fas fa-edit"></i></a> #end
		<div class="oe-editable" id="editdonatedescription-$librarycol.id"
			data-dataid="$librarycol.id" data-field="donatedescription"
			data-searchtype="librarycollection">
			#if($librarycol.donatedescription) $!librarycol.donatedescription
			#else
			<p>[[Choose Payment Method]].</p>
			#end
		</div>
		
		<p style="text-align:center;padding-top:10px;">
		<strong>[[Credit Card]]:</strong>
		</p>

		<div class="card donatecard">
		

		<div class="card-block" style="padding: 20px 21px;">

			<form action="$applink/collective/donate/donatefinish.html"
				method="post" id="payment-form" class="form">
				<input type="hidden" name="collectionid" value="$!librarycol.id" />

				

	             	<div class="row"><div class="col">
	             	<div class="float-right" style="margin-top:-4px"><img src="$applink/theme/icons/creditcard.png" /></div>
	             	<div class="form-group">
	   					<label for="staticEmail">[[Card Info]]:</label>
	   			 		<div class="form-control">
							<div id="card-element" style="width: 100%">
							</div>      
				    	</div>
	   				</div>
	             	</div></div>

						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label for="staticEmail">[[Amount]]:</label>
									<div class="input-group">
										<div class="input-group-prepend">
											<div class="input-group-text">$</div>
										</div>
										<input type="text" class="form-control"
											name="totalprice.value" id="donationamount">
									</div>
								</div>
							</div>
							<div class="col-md-6">
									<div class="form-group">
									<label for="staticEmail">[[Donation Type]]:</label> <select
										class="form-control" name="frequency">
										<option value="">[[Once]]</option>
										<option value="weekly">[[Weekly]]</option>
										<option value="monthly">[[Monthly]]</option>
										<option value="yearly">[[Yearly]]</option>
									</select>
								</div>
							</div>
						</div>


						<div id="card-errors" class="donateformerror" role="alert"></div>


						<div class="row">
							<div class="col-md-6">
								<div class="donate-secure " >
									<i class="fas fa-lock"></i> [[Secure payment]]
								</div>

							</div>
							<div class="col-md-6">
									<div style=" margin: 0px auto;">
									<a href="#" onclick='$("#payment-form").submit()' class="btn btn-success"><i class="fas fa-credit-card"></i> [[Check Out]]</a> 
									</div>
							</div>
						</div>

						<input  type="hidden" name="field" value="collectionid" /> 
						<input	type="hidden" name="collectionid.value"	value="$!librarycol.getId()" /> 
						<input  type="hidden" name="collectionid" value="$!librarycol.getId()" /> 
						<input	type="hidden" name="field" value="totalprice" /> 
						<input	type="hidden" name="field" value="userid" /> 
						<input	type="hidden" name="userid.value" value="$!user.getId()" />
						<input	type="hidden" name="isdonation" value="true" />
			</form>
		</div>
	</div>
	
	<p style="text-align:center;padding-top:20px;"><strong>[[Or Use]] PayPal:</strong></p>
	
				<div class="card donatecard" style="margin-top: 25px">

					<div class="card-block" style="padding: 00px 21px;margin-top: 25px">

						<form	action="$applink/collective/donate/paypaldonatefinish.html"
							method="post" id="paypalpayment-form" class="form">
							<input type="hidden" name="collectionid" value="$!librarycol.id" />
							<input type="hidden" name="field" value="paymentemail" />
							<input type="hidden" name="paymentemail.value" id="paypalemail"/>
							<input type="hidden" name="field" value="name" />
							<input type="hidden" name="name.value" id="paypalname"/>
							<input type="hidden" name="field" value="authorizationid" />
							<input type="hidden" name="authorizationid.value" id="paypalauthorization"/>


							<div class="row">
								<div class="col-md-6">
								
									<div class="form-group">
										<label for="staticEmail">[[Amount]]:</label>
										<div class="input-group">
											<div class="input-group-prepend">
												<div class="input-group-text">$</div>
											</div>
											<input type="hidden" name="field" value="totalprice" /> 
											
											<input type="text" class="form-control"
												name="totalprice.value" id="paypaldonationamount">
										</div>
									</div>
								</div>
								<div class="col-md-6">
																	<div class="form-group">
										<label for="staticEmail">[[Donation Type]]:</label> 
										<select class="form-control" name="frequency" id="paypalfrequency">
											<option value="">[[Once]]</option>
											<option value="weekly">[[Weekly]]</option>
											<option value="monthly">[[Monthly]]</option>
											<option value="yearly">[[Yearly]]</option>
										</select>
									</div>
								</div>
							</div>

							<!-- 
		             	<div class="row"><div class="col">
		             	<div class="form-group">
		   					<label for="staticEmail">[[Card Info]]:</label>
		   			 		<div class="form-control">
								<div id="card-element" style="width: 100%">
								</div>      
					    	</div>
		   				</div>
		             	</div></div>
 -->

							<div id="card-errors" class="donateformerror" role="alert"></div>


							<div class="row">
								<div class="col-md-6">
	<div class="donate-secure " style="margin: 30px 0;">
										<i class="fas fa-lock"></i> [[Secure payment]]
									</div>

								</div>
								<div class="col-md-6">
									##TODO: get from catalog settings
									<script
										src='https://www.paypal.com/sdk/js?client-id=$mediaarchive.getCatalogSettingValue("paypalclientid")&disable-funding=credit,card&intent=capture'></script>
										##src="https://www.paypal.com/sdk/js?client-id=AWtTwfOeBNI1ok8JfbeKd2Ld2te2isssU1nudKiv-zdd-dURV3kWfs3CMQ70M9Bj-HeqLXnMyQ6ChhDO&disable-funding=credit,card&intent=capture"></script>
									<div style="max-width: 300px; float:right; margin: 30px auto;">
										<div id="paypal-button-container"></div>
									</div>

								</div>
							</div>

							<input type="hidden" name="field" value="collectionid" /> 
							<input type="hidden" name="collectionid.value" value="$librarycol.getId()" />
							<input type="hidden" name="collectionid" value="$librarycol.getId()" />
							<input	type="hidden" name="field" value="userid" /> 
							<input	type="hidden" name="userid.value" value="$!user.getId()" />
							<input	type="hidden" name="isdonation" value="true" />

						</form>
					</div>
				</div>
	#end
	</div>
</div>


<script type="text/javascript">
  // This identifies your website in the createToken call below
 
$(document).ready(function() {
	  
    // This function sets up the details of the transaction, including the amount and line item details.
    
    //$("#paypalpayment-form").validate();
    //ok?
	 paypal.Buttons({
		    createOrder: function(data, actions) 
		    {
//https://developer.paypal.com/docs/checkout/integration-features/confirmation-page/
//https://stackoverflow.com/questions/54640821/specific-line-items-in-paypal-checkout
		      var amount = $("#paypaldonationamount").val();
		    	
		      return actions.order.create({
		    	  purchase_units: [{
		                amount: {
				            value: amount,
				            currency_code: 'USD',
		                    breakdown: {
		                        item_total: {value: amount, currency_code: 'USD'}
		                    }
		                },
		                items: [{
		                	 name: '$librarycol',
		                    unit_amount: {value: amount, currency_code: 'USD'},
		                    quantity: '1',
		                    sku: '$librarycol.getId()'
		                }]
		         }]		    	 
		    	,
		        application_context: {
                    'shipping_preference': 'NO_SHIPPING',
                    "brand_name":"$librarycol.getName()",
                }
		      });
		    },
		    onApprove: function(data, actions) {

		      // Authorize the transaction
		      actions.order.capture().then(function(authorization) {

		        // Get the authorization id
		        //var authorizationID = authorization.purchase_units[0]		          .payments.authorizations[0].id
		        var transactionid = authorization.id;
		        
		        $("#paypalauthorization").val(transactionid);

		        var first = authorization.payer.name.given_name;
		        var last = authorization.payer.name.surname;
		        $("#paypalname").val(first + " " + last);
		        
		        var email = authorization.payer.email_address;
		        $("#paypalemail").val(email);
		        
		        $("#paypalpayment-form").submit();
		        // Call your server to validate and capture the transaction
//		        console.log("Got data back");
//		        console.log(authorization);
//		        console.log(data);
//		        console.log(actions);
		      });
		    }
		  }).render('#paypal-button-container');
	
	
  
	  	// This identifies your website in the createToken call below
	  	  #if($mediaarchive.isCatalogSettingTrue("productionmode"))
	  		console.log('Production');
	  		#set($publishkey = $mediaarchive.getCatalogSettingValue("stripe_publishable_key"))
	  	  	
	  	  	
	  	 #else
			console.log('Test Publishkey');
	  		#set($publishkey = $mediaarchive.getCatalogSettingValue("stripe_test_publishable_key"))
	  	  	 
	  	  		 
	  	 #end
	  	var stripe = Stripe("$publishkey");
	   	var elements = stripe.elements();


	  	
	   	var style = {
	   		  base: {
	   		    // Add your base input styles here. For example:
	   		    fontSize: '18px',
	   		    color: "#495057"
	   		    
	   		  }
	   		};

	   		// Create an instance of the card Element.
	   		var card = elements.create('card', {style: style});

	 // Add an instance of the card Element into the `card-element` <div>
	 card.mount('#card-element');

	 // Handle real-time validation errors from the card Element.
	 card.addEventListener('change', function(event) {
	   var displayError = document.getElementById('card-errors');
	   if (event.error) {
	     $(displayError).html('<div class="errormsg">'+event.error.message+'</div>');
	   } else {
	     displayError.textContent = '';
	   }
	 });

	 var form = document.getElementById('payment-form');
	 $(form).validate({
		  rules: {
		    "totalprice.value": {
		      required: true,
		      number: true
		    }
		  },
		  submitHandler: function(form) {
		    stripe.createToken(card).then(function(result) {
		     if (result.error) {
		       // Inform the user if there was an error
		       var errorElement = document.getElementById('card-errors');
		       $(errorElement).html('<div class="errormsg">'+result.error.message+'</div>');
		     } else {
		       // Send the token to your server
		       stripeResponseHandler(result);
	
		     }
		   });
		  },
		  errorElement: "div",
		  errorClass: "errormsg",
		  errorPlacement: function(error, element) {
			  error.appendTo( element.closest(".form-group").parent() );
		      //$("#card-errors").html('<div class="errormsg">'+error.html()+'</div>');
			}
		});
	 


	  	
	 stripeResponseHandler = function( response){
		  
		 
		 
		 var form = document.getElementById('payment-form');
		  var hiddenInput = document.createElement('input');
		  hiddenInput.setAttribute('type', 'hidden');
		  hiddenInput.setAttribute('name', 'stripeToken');
		  hiddenInput.setAttribute('value', response.token.id);
		  form.appendChild(hiddenInput);

		  // Submit the form
		  form.submit();
		 
		
		  
	  }
  
}); //ready

  
</script>
