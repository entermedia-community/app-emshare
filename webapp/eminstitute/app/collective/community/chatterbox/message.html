#set( $goalfolder = $context.getRequestParameter("goalfolder"))

#if(!$goalfolder)
	#set( $goalfolder = $context.getPageValue("goalfolder") )
#end

#if(!$goalfolder)
	#set( $goalfolder = "search" )
#end
#set( $chatuser = $mediaarchive.getUser($chat.user) ) 
#set( $userlink = "$apphome/users/${chatuser.getId()}/${chatuser.getAnonNickName()}.html")
#set( $userimageurl = $mediaarchive.asLinkToProfile($chatuser.assetportrait) )
#if(!$userimageurl) #set( $userimageurl = "$apphome/theme/images/user.svg" ) #end

#set( $goal = $mediaarchive.query("projectgoal").exact("chatparentid",$chat.getId() ).searchOne() )

<div class="chatterbox-chat" role="alert"
	id="chatter-message-$chat.id">
	<div class="chat-icon">
		<a href="#esc($userlink)" title="$chatuser.getAnonNickName()"><img
			src="${userimageurl}" class="img-fluid usericon"></a>
	</div>
	#if($candeletecomments && !$goal)
		<div class="float-right" >
	
		  <a class="ajax maketicket"   
		  	data-targetdiv="chatter-message-$chat.id"
			href="$applink/collective/community/chatterbox/makegoal.html?collectionid=$librarycol.getId()&messageid=$chat.id" 
			title="[[Flag as ticket]]">
			<i class="fas fa-flag"></i></a>

	## 	 <a class="confirm" data-confirm="Are you sure?" title="Delete message"
	##		data-id="${chat.id}" data-target="#chatter-message-$chat.id"
	##		data-searchtype="chatterbox" href="#"><i class="fas fa-times"></i></a>
	##
		
		</div>
	#end
	<div class="chat-msg">
		<a href="#esc($userlink)" title="$context.getDateTime($chat.date)"><strong>
		$chatuser.getAnonNickName()</strong>
		</a><span class="chat-timestamp">$context.getDateTime($chat.date)</span>
		<br> 
		#if($chat.message)
			#if( $chat.message.startsWith("http"))
				<a href="$chat.message">$chat.message</a>
			#else
				$chat.message
			#end
		#end			 
	</div>
	<div class="clearfix"></div>
	
	#if( $goal)
		$context.putPageValue("goal",$goal)
		<div class="goalstatus goalstatus$!{goal.projectstatus}" style="position:relative"> 
		
		#set( $goallink = "$apphome/collective/goals/editgoalpanel.html?id=${goal.id}&collectionid=$goal.collectionid&hitssessionid=$!{goalhits.getSessionId()}&goalfolder=$!goalfolder")
		<a href="$goallink"
		    title="$goal.name" 
			class="emdialog goalticket-level" 
			data-urlbar="$apphome/collective/goals/priorities/index.html?collectionid=$goal.collectionid&opengoalid=${goal.id}" data-width="900" >
				<i class="fas fa-flag"></i> $!mediaarchive.getData("ticketlevel",$goal.ticketlevel) [[Ticket]]: 
				$mediaarchive.getData("projectstatus", $goal.projectstatus)
		</a>
		
		<div class="float-right">
		$pages.include("$apphome/collective/goals/like.html",$context)
		
		</div>
		<div style = "margin-right:80px">
		$pages.include("$apphome/collective/goals/search/goaltasks.html?indialog=true&onlyopen=true",$context)
		</div>
  		
		#if($goal.projectstatus != "completed")
			<a href="$apphome/collective/goals/search/resolvegoal.html?goalid=$goal.id" data-targetdiv="goal$goal.id" 
			data-oemaxlevel="1"	class="ajax btn btn-xs btn-warning btn-resolve"	
			><i class="fas fa-check"></i> [[Resolve]]
			</a>
		
		#end
		
		<div class="clearfix"></div>
		</div>
	#end
</div>