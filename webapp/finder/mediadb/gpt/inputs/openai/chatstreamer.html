#set($systeminfo = $gpt.loadInputFromTemplate($context, "/$mediaarchive.getMediaDbId()/gpt/systemmessage/entermediachat.html"))
{
	"model": "$model",
	"stream": false,
	"messages": [
		{
			"role": "system",
			"content": #jesc($systeminfo)
		},
		#foreach($message in $recent)
			
			#if($foreach.count != 1)
			,
			#end

			{
				#if($message.messagetype == "function_call")				
					"role": "function",	
					"name" : "$message.function",					
				#elseif($message.user == "agent")
					"role": "assistant",
				#else
					"role": "user",
				#end
					"content": #jesc("$!message.message $!message.functionresponse $!message.arguments")
			}
		#end		
	]
	,
	"functions": [
		{
			"name": "searchByModule",
			"description": "Search with one or more keywords in one or more modules. Keywords can be mutually exclusive or inclusive depending on the use of the word \"and\" or \"or\", default is \"or\". If modules are not specified, all modules will be searched. Modules may have conjunction too, ignore it.",
			"parameters": {
					"type": "object",
					"properties": {
							"keywords": {
									"type": "array",
									"description": "The keywords to search for",
									"items": {
											"type": "string"
									}
							},
							"conjunction": {
									"type": "string",
									"description": "The conjunction to use",
									"enum": [
											"and",
											"or"
									]
							},
							"modules": {
									"anyOf": [
										{
											"type": "string",
											"enum": ["all"],
											"description": "Search all modules. Default value if modules are not specified."
										},
										#foreach($module in $chatprofile.getEntities())
											#if($module.getBoolean("showonsearch"))
												#if($foreach.count != 1), #end
												{
													"type": "string",
													"enum": ["${module.id}", "${module.name}"],
													"description": "This is ${module.name} module.#ifnotnull($module.aisearch_contains) This module includes ${moduleProp.aisearch_contains}#end"
												}
											#end
										#end
									]
							}
					},
					"required": [
						"keywords"
					]
			}
		}
	],
	"function_call": "auto"
}