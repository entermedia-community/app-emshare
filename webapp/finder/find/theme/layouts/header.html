#if( !$sidebarcomponent && $modulehits.isEmpty() )
	#set( $sidebarcomponent = "guide" )
#end

#set( $sidebarwidth = $userprofile.get("sidebarwidth"))


#if($user)
<div class="emheader">
	#set( $workspaceproviderurl = $mediaarchive.getCatalogSettingValue("workspace-provider-url"))

	<nav class="navbar navbar-dark justify-content-between">
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="navbar-collapse collapse" id="navbarNavDropdown">
			<ul class="navbar-nav">
			
			
			#if($user)
			#set( $localesearcher = $mediaarchive.getSearcher("locale") )
		       #set($currentlang = $localesearcher.searchById($context.language))
		      	#if($currentlang)
		 			<li class="nav-item dropdown">
		 				<a class="nav-link  dropdown-toggle" href="#" data-toggle="dropdown">$currentlang</a> 
		    	#else
		 			<li class="nav-item dropdown">
		 				<a class="nav-link  dropdown-toggle" href="#" data-toggle="dropdown">[[Language]]</a> 
		     	#end
		  
				  	<div id="language-bar-select" class="dropdown-menu">
						#set( $localesearcher = $mediaarchive.getSearcher("locale") )
						#set( $languages = $localesearcher.query().match("enabled", "true").search($context) )
						#foreach( $lang in $languages)
							#set($langurl = "$home$apphome/components/languages/changelanguage.html?newlang=locale_$lang.id&origURL=$context.getPathUrl()")
							 <a class="nav-link" href="#urlescape($langurl)">$lang </a>
						#end
				    </div> 
			</li>
			#end	
			
			    #if($canviewsettings)
   					<li class="nav-item">
   					<a href="$siteroot$apphome/views/dashboard/index.html" class="nav-link ajax" 
   						data-targetdivinner="applicationmaincontent" data-updateurl="true" data-oemaxlayout="3" >[[Dashboard]]</a>
   					</li>
   				#end
			
			
			<li class="nav-item dropdown workspacedropmenu" id="workspacedropmenu">
				<a class="nav-link dropdown-toggle workspaces" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	              [[My Workspaces]]
	            </a>
		        <div id="workspacelist" class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">	</div>
			</li>
			#set( $workspaceid = $mediaarchive.getCatalogSettingsValue("workspace-id"))
			#if( $workspaceid )
			<li class="nav-item">
				<a class="nav-link" href="${workspaceproviderurl}/app/collective/community/index.html?collectionid=$workspaceid">[[Workspace Team]]</a>
			</li>
			#end
			<li class="nav-item">
				<a class="nav-link" href="$siteroot/finder/find/authentication/logout.html">[[Logout]]</a>
			</li>
			</ul>
		</div>
	</nav>
</div>
#end

<div id="header" class="mediacenterheader">
	<div class="pushcontent #if($sidebarcomponent) pushcontent-open pushcontent-$sidebarcomponent #end"
	style="#if($sidebarcomponent  && $sidebarwidth) margin-left:${sidebarwidth}px;#end">
	
	<div class="logocontainer">
		<a class="emlogo" href="$siteroot$apphome/index.html" title="[[EnterMedia Finder]]">
			<span><img src="$siteroot$themeprefix/images/emfinder.png" alt="[[EnterMedia Finder]]" /></span>
		</a>
	</div>
		
	  ###if(!$hidefilters)
	  #if($canviewquicksearchheader)
	        $pages.include("$apphome/components/gridfilters/header-search.html", $context)
	        ##$pages.include("$apphome/components/gridfilters/filters-selected.html", $context)
	    #end
	</div>
</div>


##Move This to entermedia.js
#set($siteroot = $context.getSiteRoot())
#set($siteroot = $siteroot.replace("http://","https://"))

<script>
var emKey = "#esc($userprofile.entermediacloudkey)";
if (emKey) {
	emKey = encodeURIComponent(emKey);	
	
	const rootsite='$workspaceproviderurl';
	$(".workspaces").on('click', function() {	
		var href = '$!{siteroot}/entermediadb/mediadb/services/authentication/workspacesonteam.json?noredirect=true&entermedia.key=$!{emKey}'; // TODO: call in java		
		$('#workspacelist').html('');
		$.ajax({type: "GET", url: href, crossDomain: true, 
	        success:function(result) {	        	
	        	if (result.status === "error") {
	        		const url = '<a class="dropdown-item" target="_blank" href="https://emediafinder.com">eMediaFinder.com</a>';
	        	  	$('#workspacelist').append(url);
	        		return;
	        	}	        	
	        	if (result.workspaces.length > 0) {
		        	$.each(result.workspaces, function (i, ws) {
		        		console.log(result);
		        		const url = '<a class="dropdown-item" href="'
		        		 	+ ws.url + '/finder/find/startmediaboat.html?'
		        			+ 'entermediacloudkey=' + result.userKey 
		        			+ "&collectionid=" + ws.collectionid + '">'
		        			+ ws.name + '</a>';
		        	    $('#workspacelist').append(url);
		        	});
	        	} else {
	        		const url = '<a class="dropdown-item" target="_blank" href="https://emediafinder.com/app/workspaces/index.html">Create a Workspace</a>';
		        	$('#workspacelist').append(url);
		            return;
	        	}
	        },
	        error:function(result) {
	        }
	    });
	});
} else {
	const url = '<a class="dropdown-item" target="_blank" href="https://emediafinder.com">eMediaFinder.com</a>';
  	$('#workspacelist').append(url);
}

//url: href, async: false, data: {}, success: function (data) {		
//	console.log('thing');
//}
</script>
