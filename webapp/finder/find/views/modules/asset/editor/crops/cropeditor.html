#set( $presetid = $context.getRequestParameter("presetid") )

#set( $preset = $mediaarchive.getCachedData("convertpreset", $presetid) )

#set( $dimension = $conversionUtil.getConvertPresetDimension($mediaarchive.getCatalogId(), $presetid) )

#set( $aspectratio = $conversionUtil.getConvertPresetAspectRatio($dimension) )

#set( $cropbox = $conversionUtil.loadCropBox($mediaarchive, $asset, $preset) )

#set($cropuser = $mediaarchive.getUser($cropbox.userid))

<div id="cropeditor" class="d-flex flex-column align-items-center justify-content-center flex-grow-1">
  <div class="mb-3 text-center">
    <h4 class="p-0 mb-1">$preset.getName()<span class="mx-2">&middot;</span><span class="text-muted">( $aspectratio )</span></h4>
    #ifnotnull($cropuser)
      <span class="text-muted">[[Last modified by ]] #text($cropuser)</span>
    #end
  </div>

  #set ($img = $mediaarchive.asLinkToPreview($asset, "image3000x3000") )
  <form class="d-flex align-items-center ajaxform" data-targetdiv="asset-editor-container" action="${apphome}/views/modules/asset/editor/crops/save.html" method="post" id="cropform">
    
    <input type="hidden" name="assetid" value='$asset.getId()'>

    <input name="field" value="crop" type="hidden" />
    <input name="crop.value" value="true" type="hidden" />
    
    <input name="field" value="presetid" type="hidden" />
    <input name="presetid.value" value="${presetid}" type="hidden" />
    
    <input name="field" value="x1" type="hidden" />
    <input name="x1.value" value="" type="hidden" />
    
    <input name="field" value="y1" type="hidden" />
    <input name="y1.value" value="" type="hidden" />
    
    <input name="field" value="cropwidth" type="hidden" />
    <input name="cropwidth.value" value="" type="hidden" />
    
    <input name="field" value="cropheight" type="hidden" />
    <input name="cropheight.value" value="" type="hidden" />
    
    <input name="field" value="cropprevieww" type="hidden" />
    <input name="cropprevieww.value" value="" type="hidden" />
    
    <input name="field" value="croppreviewh" type="hidden" />
    <input name="croppreviewh.value" value="" type="hidden" />
    
    <button class="btn btn-lg btn-cta m-2" type="submit">
      <i class="bi bi-crop mr-2"></i> [[Crop]]
    </button>
    
  </form>

  #set($cheight = $mathtool.toInteger($dimension.getHeight()))
  #set($cwidth = $mathtool.toInteger($dimension.getWidth()))

  <div id="cropinner"
      data-originalwidth="$asset.getInt('width')"
      data-originalheight="$asset.getInt('height')"
      data-cropx="${cropbox.cropx}"
      data-cropy="${cropbox.cropy}"
      data-cropw="${cropbox.cropwidth}"
      data-croph="${cropbox.cropheight}" 
      data-cropheight="${cheight}"
      data-cropwidth="${cwidth}"
      data-cropaspectratio="$aspectratio">

    <img src="$img" id="croptarget" />

    <div id="preview-pane">
      <div class="preview-container" style="width: ${cwidth}px; height: ${cheight}px; aspect-ratio: ${cwidth} / ${cheight}">
        <img src="$img" class="jcrop-preview" alt="Preview" />
      </div>
    </div>
  </div>
  
  <script> 
   (function () { 
      var cropper,
        boundX,
        boundY,
        crop_inner = $("#cropinner"),
        cropBox = {          
          x: crop_inner.data("cropx"),
          y: crop_inner.data("cropy"),
          w: crop_inner.data("cropw"),
          h: crop_inner.data("croph"),
        },
        original_width = crop_inner.data("originalwidth"),
        original_height = crop_inner.data("originalheight"),
        aspect_ratio = original_width / original_height,
        crop_width = crop_inner.data("cropwidth"),
        crop_height = crop_inner.data("cropheight"),
        crop_aspect_ratio = parseFloat(crop_inner.data("cropaspectratio")),
        preview = $("#preview-pane"),
        preview_container = $("#preview-pane .preview-container"),
        preview_image = $("#preview-pane .preview-container img"),
        preview_width = preview_container.width(),
        preview_height = preview_container.height();

      var crop_inner_width = crop_inner.width() - 32;
      var crop_inner_height = crop_inner.height() - 32;

      crop_width = Math.min(crop_width, crop_inner_width * 0.4);
      crop_height = crop_width / crop_aspect_ratio;
      if (crop_height > crop_inner_height) {
        var scale = crop_inner_height / crop_height;
        crop_width = crop_width * scale;
        crop_height = crop_inner_height;
      }

      var cropper_width = Math.max(
        crop_inner_width * 0.6,
        crop_inner_width - crop_width
      );
      var cropper_height = cropper_width / aspect_ratio;
      if (cropper_height > crop_inner_height) {
        var scale = crop_inner_height / cropper_height;
        cropper_width = cropper_width * scale;
        cropper_height = crop_inner_height;
      }

      preview.css({
        top: 0,
        right: -crop_width + "px",
        width: crop_width + 14 + "px",
        height: crop_height + 14 + "px",
      });

      preview_container.css({
        width: crop_width + "px",
        height: crop_height + "px",
      });
      
      preview_image.css({
        width: crop_width + "px",
        height: crop_height + "px",
      });

      $("#croptarget").css({
        width: cropper_width + "px",
        height: cropper_height + "px",
      });

      var mainScale = cropper_width / original_width;
      
      var scaledCroppedBox = [
        cropBox.x * mainScale,
        cropBox.y * mainScale,
        cropBox.x * mainScale+cropBox.w * mainScale,
        cropBox.y * mainScale+cropBox.h * mainScale
      ]; 

      $("#croptarget").Jcrop(
        {
          setSelect: scaledCroppedBox,
          onChange: updatePreview,
          onSelect: function() {
            updatePreview(this);
            if(this.ui)
            setForm(this.ui.holder, this.ui.selection);
          },
          minSize: [50, 50/crop_aspect_ratio],
          aspectRatio: preview_width / preview_height,
        },
        function () { 
          var bounds = this.getBounds();
          boundX = bounds[0];
          boundY = bounds[1];
          cropper = this; 

          cropper.setSelect(scaledCroppedBox);

          preview.appendTo(cropper.ui.holder);
          setForm(cropper.ui.holder, cropper.ui.selection);
        }
      );

      function updatePreview(c) {
        if (parseInt(c.w) > 0) {
          var rx = crop_width / c.w;
          var ry = crop_height / c.h;
          preview_image.css({
            width: Math.round(rx * boundX) + "px",
            height: Math.round(ry * boundY) + "px",
            marginLeft: "-" + Math.round(rx * c.x) + "px",
            marginTop: "-" + Math.round(ry * c.y) + "px",
          });
        }
      }
      function setForm(holder, selection) {
        var H = $(holder).offset();
        var S = $(selection).offset();
        var pos = {
          x: S.left - H.left,
          y: S.top - H.top,
          w: $(selection).width(),
          h: $(selection).height()
        };

        $("#cropform input[name='x1.value']").val(pos.x/mainScale);
        $("#cropform input[name='y1.value']").val(pos.y/mainScale);
        $("#cropform input[name='cropwidth.value']").val(pos.w/mainScale);
        $("#cropform input[name='cropheight.value']").val(pos.h/mainScale);
      }
    })(); 
  </script>
</div>
