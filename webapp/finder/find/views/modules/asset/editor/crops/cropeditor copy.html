#set($presetid = $context.getRequestParameter("presetid"))

#set($preset = $mediaarchive.query("convertpreset").exact("id", $presetid).searchOne())
#set($assetcrop = $mediaarchive.query("assetcrop").exact("assetid", $asset.id).exact("presetid", $presetid).searchOne())

#set($dimension = $conversionUtil.getConvertPresetDimension($mediaarchive.getCatalogId(), $presetid))

#set($aspectratio = $conversionUtil.getConvertPresetAspectRatio($dimension))

<div id="cropeditor" class="d-flex flex-column align-items-center justify-content-center flex-grow-1">
  <div id="cropdata" 
    class="d-none" 
    data-aspectratio="$aspectratio"
    #ifnotnull($assetcrop)
      data-cropx='${assetcrop.get("cropx")}'
      data-cropy='${assetcrop.get("cropy")}'
      data-cropwidth='${assetcrop.get("cropwidth")}'
      data-cropheight='${assetcrop.get("cropheight")}'
      data-croppreviewwidth='${assetcrop.get("croppreviewwidth")}'
      data-croppreviewheight='${assetcrop.get("croppreviewheight")}'
    #end></div>
  <div class="mb-3 text-center">
    <h4 class="p-0 mb-1">$preset.getName() </h4>
    <span class="text-muted">$aspectratio</span>
  </div>
  
  #set ($img = $mediaarchive.asLinkToPreview($asset, "image3000x3000") )

  <img src="$img" id="cropsubject">

  <form class="d-flex align-items-center ajaxform" data-targetdiv="asset-editor-container" action="${apphome}/views/modules/asset/editor/crops/save.html" method="post" id="cropform">
    <input type="hidden" name="sourcepath" value='$asset.get("sourcepath")'>
    <input name="field" value="crop" type="hidden" />
    <input name="crop.value" value="true" type="hidden" />
    
    <input name="field" value="presetid" type="hidden" />
    <input name="presetid.value" value="${presetid}" type="hidden" />
    
    <input name="field" value="x1" type="hidden" />
    <input name="x1.value" value="" type="hidden" />
    
    <input name="field" value="y1" type="hidden" />
    <input name="y1.value" value="" type="hidden" />
    
    <input name="field" value="cropwidth" type="hidden" />
    <input name="cropwidth.value" value="" type="hidden" />
    
    <input name="field" value="cropheight" type="hidden" />
    <input name="cropheight.value" value="" type="hidden" />
    
    <input name="field" value="cropprevieww" type="hidden" />
    <input name="cropprevieww.value" value="" type="hidden" />
    
    <input name="field" value="croppreviewh" type="hidden" />
    <input name="croppreviewh.value" value="" type="hidden" />
    
    <button class="btn btn-lg btn-primary m-2" type="submit">
      <i class="bi bi-crop mr-2"></i> [[Crop]]
    </button>
    
  </form>
  
  <script>
    (function() {
      var cropdata = $("#cropdata").data();
      var aspect = cropdata.aspectratio.split(":");
      var aspectratio = parseFloat(aspect[0]);

      if(isNaN(aspectratio)) {
        aspectratio = 1;
        console.warn("Invalid aspect ratio, defaulting to 1:1");
      }

      var cropData;

      var options = {
        allowResize: true,
        handles: true,
        aspectRatio: aspectratio, 
        boxWidth: Math.min(1000, $(window).width() - 500), 
        setSelect: [0, 0, 200, 400],
      }

      $('#cropsubject').Jcrop({
        ...options, 
        onSelect: function() {
          if(this.ui) {
            setForm(this.ui.holder, this.ui.selection);
          }
        } 
      }, function() {
        this.focus();
        if(this.ui) {
          setForm(this.ui.holder, this.ui.selection);
          
          var scaleFactor = parseInt(cropdata.croppreviewwidth) / options.boxWidth;
          console.log({cropdata, scaleFactor});
          if(!isNaN(scaleFactor) && scaleFactor > 0) {
            if(cropdata.cropx >=0 && cropdata.cropy >=0 && cropdata.cropwidth && cropdata.cropheight) {
              var setSelect = [
                parseInt(cropdata.cropx) / scaleFactor,
                parseInt(cropdata.cropy) / scaleFactor,
                (parseInt(cropdata.cropx) + parseInt(cropdata.cropwidth)) / scaleFactor,
                (parseInt(cropdata.cropy) + parseInt(cropdata.cropheight)) / scaleFactor
              ];
              console.log({setSelect});
              this.animateTo(setSelect);
            }
          }
        }
      });

      function setForm(holder, selection) {
        var H = $(holder).offset();
        var S = $(selection).offset();
        var pos = {
          x: S.left - H.left,
          y: S.top - H.top,
          w: $(selection).width(),
          h: $(selection).height()
        };
        $("#cropform input[name='x1.value']").val(pos.x);
        $("#cropform input[name='y1.value']").val(pos.y);
        $("#cropform input[name='cropwidth.value']").val(pos.w);
        $("#cropform input[name='cropheight.value']").val(pos.h);
        var ar = $('#cropsubject').width() / $('#cropsubject').height();
        var w = options.boxWidth;
        var h = w / ar;
        $("#cropform input[name='cropprevieww.value']").val(w);
        $("#cropform input[name='croppreviewh.value']").val(h);
      }
    })();
  </script>
</div>
