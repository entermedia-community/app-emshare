#set( $syncfolder = $mediaarchive.query("desktopsyncfolder").exact("desktop", $desktop.getComputerName()).exact("entityid", $entity.getId()).searchOne() )

#set( $processing = false )
#if($syncfolder)
  #if($syncfolder.desktopimportstatus == "scan-started" || $syncfolder.desktopimportstatus == "sync-started")
    #set($processing = true)
  #end
#end

<div id="desktoppendingpopover"
  #if($processing)
    class="ajaxstatus" 
  #end
  data-oemaxlevel="1" 
  #if($entity)
    data-entitymoduleid="$!entitymodule.id"
    data-entityid="$!entity.getId()"
  #else
    data-entitymoduleid="category"
    data-entityid="$!category.getId()"
  #end
  data-categoryid="$!category.getId()"
  data-targetdiv="desktoppendingpopover"
  data-url="$page.path"
  data-ajaxpath="$page.path">
  <div class="d-flex flex-column lightbox-header-btns p-2 ofl-path mx-auto"
    style="max-width: 180px;"
    #if($entity)
      data-entitymoduleid="$!entitymodule.id"
      data-entityid="$!entity.getId()"
    #else
      data-entitymoduleid="category"
      data-entityid="$!category.getId()"
    #end
    data-path="$!category.getCategoryPath()">
    <div class="d-flex align-items-center justify-content-between mb-2" style="line-height: 1;">
      <span class="contrast-text">
        #ifnotnull($syncfolder.completeddate)
          <span class="last-scanned">
            #set($ago = $context.getAge($syncfolder.getDate("completeddate")))
            Last scanned
            #ifnull($ago)
            1 second ago
            #end
            #ifnotnull($ago)
            <span style="text-transform:lowercase;">$ago</span> ago
            #end
          </span>
        #end
      </span>
      <label for="desktopSyncToggle" class="close m-0">
        <i class="bi bi-x ns"></i>
      </label>
    </div>
    <div class="work-dir-tree">
      <div class="work-folder download upload #if($processing) processing #end"
        data-categorypath="$!category.getCategoryPath()"
        data-entitymoduleid="$!entitymodule.id"
        data-entityid="$!entity.getId()">
        <div class="currentSync mb-2">
          <p class="mb-2 text-primary">
            Uploading $syncfolder.currentfoldertotalcount files <strong>($syncfolder.currentfoldertotalsize)</strong>
          </p>
          <p class="mb-1 text-muted fileName">$syncfolder.currentfoldername</p>
          #*
          <div class="progress">
            <div class="progress-bar progress-bar-striped fileProgress" style="width: 100%"></div>
          </div>
          <p class="mt-1 mb-0 text-right">
            <span><span class="fileProgressLoaded"></span> / <span class="fileProgressTotal"></span></span>
          </p>
          *#
          <div class="text-center mt-1">
            <button class="border-0 bg-white mx-auto text-danger cancelSync"
              data-categorypath="$!category.getCategoryPath()"
              data-both="true"
              title="[[Cancel this task]]">
              <i class="bi bi-x"></i> [[Cancel]]
            </button>
          </div>
        </div>
      </div>
    </div>
  
    #ifnotnull($assetsource)
      #set($userlocaldesktoppath  = $assetsource.getConfig().get("userlocaldesktoppath"))
      #ifnotnull($userlocaldesktoppath)
        #set($removecategorysubfolder  = $assetsource.getConfig().get("subfolder"))
      #end
    #end
  
    #ifnotnull($userlocaldesktoppath)
      <button class="lightbox-header-btn open-folder" 
        data-root="${userlocaldesktoppath}"
        data-removecategorysubfolder="$!removecategorysubfolder">
        <i class="bi bi-eye-fill mr-1 ns"></i> <span>[[Open Folder]]</span>
      </button>
    #end
    
    #ifnull($userlocaldesktoppath)
      #if($module.id!="faceprofilegroup" && $module.id!="modulesearch")
        <div class="d-flex flex-column">
          #if($permissions.canModule($module, "downloadall"))
            <button class="lightbox-header-btn download-lightbox positive" style="margin-bottom:6px">
              <i class="bi bi-cloud-arrow-down mr-1 ns"></i> <span>[[Download Folder]]</span>
            </button>
          #end
          <button class="lightbox-header-btn open-folder flex-grow-1" style="margin-bottom:6px">
            <i class="bi bi-eye-fill mr-1 ns"></i> <span>[[Open Folder]]</span>
          </button>
          #if($permissions.canModule($module, "upload_folders"))
            <button class="lightbox-header-btn upload-lightbox" style="margin-bottom:6px">
              <i class="bi bi-cloud-arrow-up mr-1 ns"></i> <span>[[Upload Folder]]</span>
            </button>
          #end
        </div>
  
      #end
    #end
  </div>
</div>