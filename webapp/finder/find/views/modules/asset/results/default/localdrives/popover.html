#set( $syncfolder = $mediaarchive.query("desktopsyncfolder").exact("desktop", $desktop.getComputerName()).exact("entityid", $entity.getId()).orgroup("desktopimportstatus", "scan-started sync-started").searchOne() )

#ifnull($syncfolder)
  #set( $syncfolder = $mediaarchive.query("desktopsyncfolder").exact("desktop", $desktop.getComputerName()).exact("entityid", $entity.getId()).sort("completeddateDown").searchOne() )
#end

#set( $processing = false )
#if($syncfolder)
  #if($syncfolder.desktopimportstatus == "scan-started" || $syncfolder.desktopimportstatus == "sync-started")
    #set($processing = true)
  #end
#end

<div id="desktoppendingpopover"
  #if($entity)
    data-entitymoduleid="$!entitymodule.id"
    data-entityid="$!entity.getId()"
  #else
    data-entitymoduleid="category"
    data-entityid="$!category.getId()"
  #end
  data-syncfolderid="$!syncfolder.id"
  data-categoryid="$!category.getId()"
  data-targetdiv="desktoppendingpopover"
  data-url="$page.path"
  data-no-toast="true">
  <div class="d-flex flex-column lightbox-header-btns p-2 ofl-path mx-auto"
    style="max-width: 180px;"
    #if($entity)
      data-entitymoduleid="$!entitymodule.id"
      data-entityid="$!entity.getId()"
    #else
      data-entitymoduleid="category"
      data-entityid="$!category.getId()"
    #end
    data-path="$!category.getCategoryPath()">
    <div class="d-flex align-items-center justify-content-between mb-2" style="line-height: 1;">
      <span class="contrast-text">
        #ifnotnull($syncfolder.completeddate)
          <span class="last-scanned">
            #set($ago = $context.getAge($syncfolder.getDate("completeddate")))
            Last synced
            #ifnull($ago)
            1 second ago
            #end
            #ifnotnull($ago)
            <span style="text-transform:lowercase;">$ago</span> ago
            #end
          </span>
        #end
        #ifnull($syncfolder.completeddate)
          #if($processing)
            <span class="last-scanned">
              #if($syncfolder.isdownload == "true")
                Downloading...
              #else
                Uploading...
              #end
            </span>
          #end
        #end
      </span>
      <label for="desktopSyncToggle" class="close m-0">
        <i class="bi bi-x ns"></i>
      </label>
    </div>

    #if($processing)
    <div class="work-dir-tree">
      <div class='work-folder #if($syncfolder.isdownload == "true") download #else upload #end #if($processing) processing #end'
        data-syncfolderid="$!syncfolder.id"
        data-categorypath="$!syncfolder.categorypath"
        data-entitymoduleid="$!syncfolder.entitymoduleid"
        data-entityid="$!syncfolder.entityid">
        <div class="currentSync mb-2">
          <p class="mb-1 text-primary fileName">$syncfolder.currentcategorypath</p>
          <p class="mb-2 text-muted">
            <span class="fileCompletedCount"></span>$syncfolder.currentfoldertotalcount files
          </p>
          <div class="progress">
            <div class="progress-bar progress-bar-striped fileProgress"></div>
          </div>
          <p class="mt-1 mb-0 text-right">
            <span>
              <span class="fileCompletedSize"></span> 
              <span class="fileTotalSize" data-total="$!syncfolder.currentfoldertotalsize">
                $sizer.inEnglish($syncfolder.currentfoldertotalsize)
              </span>
            </span>
          </p>
          <div class="text-center mt-1">
            <button class='border-0 bg-white mx-auto text-danger cancelSync #if($syncfolder.isdownload == "true") download #else upload #end'
              data-syncfolderid="$!syncfolder.id"
              title="[[Cancel this task]]">
              <i class="bi bi-x"></i> [[Cancel]]
            </button>
          </div>
        </div>
      </div>
    </div>
    #end
  
    #ifnotnull($assetsource)
      #set($userlocaldesktoppath  = $assetsource.getConfig().get("userlocaldesktoppath"))
      #ifnotnull($userlocaldesktoppath)
        #set($removecategorysubfolder  = $assetsource.getConfig().get("subfolder"))
      #end
    #end
  
    #ifnotnull($userlocaldesktoppath)
      <button class="lightbox-header-btn open-folder" 
        data-root="${userlocaldesktoppath}"
        data-removecategorysubfolder="$!removecategorysubfolder">
        <i class="bi bi-eye-fill mr-1 ns"></i> <span>[[Open Folder]]</span>
      </button>
    #end
    
    #ifnull($userlocaldesktoppath)
      #if($module.id!="faceprofilegroup" && $module.id!="modulesearch")
        <div class="d-flex flex-column">
          #if($permissions.canModule($module, "downloadall"))
            <button class="lightbox-header-btn download-lightbox positive" style="margin-bottom:6px">
              <i class="bi bi-cloud-arrow-down mr-1 ns"></i> <span>[[Download Folder]]</span>
            </button>
          #end
          <button class="lightbox-header-btn open-folder flex-grow-1" style="margin-bottom:6px">
            <i class="bi bi-eye-fill mr-1 ns"></i> <span>[[Open Folder]]</span>
          </button>
          #if($permissions.canModule($module, "upload_folders"))
            <button class="lightbox-header-btn upload-lightbox" style="margin-bottom:6px">
              <i class="bi bi-cloud-arrow-up mr-1 ns"></i> <span>[[Upload Folder]]</span>
            </button>
          #end
        </div>
      #end
    #end
  </div>
</div>