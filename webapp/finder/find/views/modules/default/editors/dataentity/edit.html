
#ifnull($id)
	#set( $id = $context.getRequestParameter("entityid"))
	$context.putPageValue("id", $id)
#end

#set( $ismulti = $id.startsWith("multiedit:") || $context.getRequestParameter("multi") == "true")

#ifnull($data)
	#set($data = $entity)
#end

#ifnull($data)
	#set($data = $mediaarchive.getSearcher($module.id).createNewData())
	
	#set ($fieldexternalid = $context.getRequestParameter("fieldexternalid"))
	#set ($fieldexternalvalue = $context.getRequestParameter("fieldexternalvalue"))
	#ifnotnull($fieldexternalid)
		$data.setValue($fieldexternalid, $fieldexternalvalue)
	#end
#end

$context.putPageValue("data",$data)

#set( $searcher = $mediaarchive.getSearcher($module.id) )
$context.putPageValue("searcher",$searcher)


#set($edit = $context.getRequestParameter("edit"))
#if($edit!="true")
	#set($edit="false")
#end
$context.putPageValue("edit", $edit)

#ifnull($viewid)
#set($viewid = $context.getRequestParameter("viewid"))
#end

#if($ismulti)
	$context.putPageValue("multiedit", $ismulti)
#end

<div id="editentitymetadata"
	data-oemaxlevel="1" 
	data-url="${edithome}/index.html?edit=true&entityid=$!data.id" 
	class='entity-metadata entitymetadatamodal #if($edit=="true") entitymetadataediting #else entitymetadatapreview #end' 
	data-id="$!id">

	#if($ismulti)
		#set($targetentitytabid = "entity-tab-multiedit")
	#else
		#set($addnew = $context.getRequestParameter("addnew"))
		#if($addnew)
			#set($viewid = "${searchtype}addnew")
			#set($reloadtargets = $context.getRequestParameter("reloadtargets"))
		
		#end
		#set($targetentitytabid = "entity-tab-#eid($id)")
	#end

	#ifnotnull($data)
		#if( $module.getBoolean("enableuploading"))
			#set($defaultfolder =  $mediaarchive.getEntityManager().loadDefaultFolder($module, $data, $context.getUser()))
			$context.putPageValue("defaultfolder", $defaultfolder)
		#end
	#end

	#set($view = "${module.id}/$viewid")

	<form id="entitydataeditor" 
		name="entitydataeditor" 
		class="ajaxform checkCloseDialog" 
		data-targetdiv="entitydialog"
		data-oemaxlevel="1"
		#if($addnew && $reloadtargets)
			data-ajaxreloadtargets="$reloadtargets"
		#else
			data-ajaxreloadtargets="dataeditedreload"
		#end
		method="post"  
		action="${edithome}/save.html"
		enctype="multipart/form-data">

		<input name="save" type="hidden" value="true" />

		#set($saveaction = $context.getRequestParameter("saveaction"))
		<input name="saveaction" type="hidden" value="$!saveaction" />

		#set($copyinghitssessionid = $context.getRequestParameter("copyinghitssessionid"))
		<input name="copyinghitssessionid" type="hidden" value="$!copyinghitssessionid" />

		#set($copyingsearchtype = $context.getRequestParameter("copyingsearchtype"))
		<input name="copyingsearchtype" type="hidden" value="$!copyingsearchtype" />
		<input name="pickedmoduleid" type="hidden" value="$!module.id" />
		
		#set($pickedassetid = $context.getRequestParameter("pickedassetid"))
		<input name="pickedassetid" type="hidden" value="$!pickedassetid" />
			
		#set($copyingcategoryid = $context.getRequestParameter("copyingcategoryid"))
		<input name="copyingcategoryid" type="hidden" value="$!copyingcategoryid" />

		<input name="id" type="hidden" value="$!id" />
		<input name="entityid" type="hidden" value="$!id" />
		<input name="entitymoduleid" type="hidden" value="$!entitymodule.id" />
		<input name="viewid" type="hidden" value="$!viewid" />
		<input name="view" type="hidden" value="$!view" />
		<input name="entitymoduleviewid" type="hidden" value="$!entitymoduleviewid" />

		#if(!$hitssessionid)
			#set( $hitssessionid = $context.getRequestParameter("hitssessionid"))
		#end
		#if($hitssessionid)
			<input name="hitssessionid" type="hidden" value="$hitssessionid" />
		#end
		#ifnull($showmedia)
			#set($showmedia = $context.getRequestParameter("showmedia"))
		#end
		#ifnotnull($showmedia)
			<input name="showmedia" type="hidden" value="$showmedia" />
		#end

		$context.putPageValue("view", $view)
		$context.putPageValue("viewid", $viewid)

		#if($edit =="true")  ##TODO - Permissions
			$pages.include("$apphome/views/modules/${module.id}/components/xml/detaileditor-entities.html?longform=true", $context)
		#else
			$context.putPageValue("tagssearchlink", "$siteroot$apphome/views/modules/$module.id/index.html")
			$pages.include("$apphome/components/xml/detaileditor-entities.html?detailsreadonly=true&alwaysshow=true", $context)
		#end

		<div class="d-flex align-items-center justify-content-between form-submit-btns">
			<div class="d-flex align-items-center">
				#if($edit=="true")
					<a class="btn btn-cta submitform mr-2"><i class="bi bi-floppy-fill mr-1"></i> [[Save]]</a>
					#if($id) 
						#if($id.startsWith("multiedit"))
							<button id="closebutton" type="button" class="btn btn-secondary mr-2" data-dismiss="modal">[[Cancel]]</button>
						#else
							<a class="btn btn-secondary mr-2 ajax" 
								data-targetdiv="editentitymetadata"
								data-oemaxlevel="1" 
								href="${edithome}/index.html?entityid=$!id&viewid=$!viewid">[[Cancel]]</a>
						#end
					#else
						<button id="closebutton" type="button" class="btn btn-secondary mr-2" data-dismiss="modal">[[Cancel]]</button>
					#end
				#else
					#if($permissions.can($module.id, "edit"))
						#if(!$ismultisaved) 
							<a href="${edithome}/index.html?edit=true&showmedia=$!showmedia&viewid=$!viewid&hitssessionid=$!hitssessionid" 
								data-targetdiv="editentitymetadata"
								data-entityid="${data.id}"
								data-id="${data.id}" 
								data-oemaxlevel="1"
								class="ajax btn btn-cta" 
								style="margin-right:10px;"><i class="bi bi-pencil-square mr-1"></i> [[Edit]]</a>
						#end
					#end
					#if($canviewmodulesettings)
						<a class="emdialog btn btn-light px-2 mr-2" 
							href="$siteroot$apphome/views/settings/modules/$!{searcher.searchType}/metadata/views/dialog/index.html?viewid=$viewid&viewpath=$!view"
							title="[[Edit Fields]]" data-dialogid="fieldpicker" data-hidefooter="true">
							<i class="bi bi-gear-fill mr-1"></i> [[Fields]]
						</a>
					#end
				#end
			</div>
			<div class="d-flex align-items-center">
				#if(!$ismulti && $permissions.can($module.id, "delete"))
					<a href="${edithome}/delete.html?id=$data.id" 
						class="ajax btn btn-danger" 
						data-targetdiv="editentitymetadata" 
						data-ajaxreloadtargets="dataeditedreload"
						data-alertmessage="[[Deleted Successfully]]"
						data-closedialog="true" 
						data-confirm="[[Are you sure]]?"
						data-id="$data.id">
						<i class="bi bi-trash mr-1"></i>[[Delete]]
					</a>
				#end
			</div>
		</div>
	</form>
</div>
