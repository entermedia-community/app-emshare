#set($edithome = "${apphome}/views/modules/asset/editors/assetpickentity")

#set($canviewentities = true)
#set($entities = $mediaarchive.getEntityManager().getEntitiesForCategories($context, $asset.categories) )

#if($entities.isEmpty())
	#if(!$caneditasset)
		#set($canviewentities = false)
	#end
#end

#if($canviewentities)
<div id="assetentityresultsmediaviewer">
	<div class="asset-data-detail assetpanel-editor-box">
		<h4>[[Entities]]</h4>
		#if(!$entities.isEmpty())
			<div class="px-3">
				#foreach ( $data in $entities)
					#set($entity = $data)
					#set($entityid = $data.getId())
					#set($emoduleid = $data.get("entitysourcetype"))

					#set($emodule = $mediaarchive.getCachedData("module", $emoduleid))
					
					#set($rendertype = $emodule.modulerendertype)
					#if (!$rendertype)
						#set($rendertype = "entity")
					#end
					$context.putPageValue("rendertype", $rendertype)
					$context.putPageValue("rendermoduleid", $emoduleid)
					
					#set($moduleicon = "entity")
					#if ($emodule.moduleicon)
						#set($moduleicon = $emodule.moduleicon)
					#end
						
					#set($previewurl = "${apphome}/views/modules/${emodule.id}/editors/default/tabs/index.html?entityid=$entity.getId()")
					
					$context.putPageValue("hit", $entity)
					
					#set($moduleicon = "entity")
					#if ($module.moduleicon)
						#set($moduleicon = $module.moduleicon)
					#end
					
						<a href="$previewurl"
						class="emdialog emgridresulttitle badge badge-tags mr-1"
						data-hidefooter="true"
						data-hideheader="true"
						id="clickid${entityid}"
						data-id="${entityid}"
						data-moduleid="$!emoduleid"
						title="#text($!entity)">
						<i class="bi bi-$moduleicon mr-1"></i>&nbsp;#text($entity.sourcepath)</a>
				#end

				#set( $rendertype = $mediaarchive.getMediaRenderType($asset.fileformat))
				#if($rendertype == "document")
					<br>
					#set($entitydocument = $mediaarchive.query("entitydocument").exact("parentasset", $asset.id).searchOne())
					#ifnotnull($entitydocument)
						#set($docurl = "${apphome}/views/modules/entitydocument/index.html?entityid=${entitydocument.id}")
						<a href="$docurl"
							data-baseurl="${apphome}/views/modules/entitydocument/index.html"
							data-urlbar="$docurl"
							data-updateurl="true"
							class="emdialog entity-dialog btn-accent badge badge-tags mr-1"
							data-dialogid="entitydialog"
							data-hidefooter="true"
							data-hideheader="true"
							data-entityid="${entitydocument.id}"
							data-id="${entitydocument.id}"
							data-moduleid="entitydocument"
							title="View: #text($!entitydocument)">
							<i class="bi bi-file-earmark-text-fill mr-1"></i>&nbsp; #text($entitydocument)
						</a>
					#end
					#ifnull($entitydocument)
						$pages.include("$apphome/views/modules/asset/editor/documentindexer/button.html", $context)
					#end
				#end

			</div>
		#end
	</div>
	
	
	#if($caneditasset)
		<div class="asset-data-detail assetpanel-editor-box" style="padding:12px; margin-bottom: 20px;">
			<div class="folder-list-actions">
				<div class="dropdown">
					<a class="btn btn-dark dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						<i class="fas fa-plus"></i> [[Add to Entity]]
					</a>
					<div class="dropdown-menu dropdown-menu-top" aria-labelledby="dropdownMenuLink">
						#foreach ( $amodule in $userprofile.getEntities() )
							#set($amoduleid = $amodule.getId())
							#if($amodule.getBoolean("enableuploading"))
								#if($permissions.canModule($amodule, "create") && $amoduleid!="faceprofilegroup" && $amoduleid!="asset" && $amoduleid!="modulesearch")
									#set($entityrendertype = "entity")
									#if ($amodule.modulerendertype)
										#set($entityrendertype = $amodule.modulerendertype)
									#end
									
									#set($addurl = "${apphome}/views/modules/${amodule.id}/editors/assetpickentity/index.html")
		
									<a class="dropdown-item emdialog"
										href="$addurl"
										data-dialogid="addtoentity"
										data-maxwidth="1400"
						    			data-hidefooter="true"
										data-assetid="$!{asset.id}"
										>#text($amodule)</a>
							#end
						#end
					#end
					</div>
				</div>
			</div>
		</div>
	#end
<div class="clearfix"></div>
</div>
#end
