#set( $id = $context.getRequestParameter("id"))
#ifnull($id)
	#set( $id = $context.getRequestParameter("dataid"))
#end
#ifnull($id)
	#set( $id = $context.getRequestParameter("entityid"))
#end
$context.putPageValue("id", $id)
$context.putPageValue("parentid", $id)

#set( $ismulti = $id.startsWith("multiedit:") || $context.getRequestParameter("multi") == "true")
$context.putPageValue("ismulti", $ismulti)

#if($ismulti)

#else
	#if( !$entity && $id)
		#set( $entity  = $mediaarchive.getCachedData($entitymodule.id, $id) )
	#end
	#if($entity)
		#set($entityid = $entity.id)
		$context.putPageValue("entity", $entity)
		$context.putPageValue("entityid", $entityid)
		
		##Publishing (Gallery)
		#if($permissions.can($moduleid, "publishinggallery"))
			#set($canpublishinggallery = true)
		#end
		#if($permissions.can($moduleid, "publishingcarousel"))
			#set($canpublishingcarousel = true)
		#end
	#end
#end


#set($enttiyviews = $mediaarchive.query("view").exact("moduleid", $module.id).exact("systemdefined","false").sort("orderingUp").search($context) )
$context.putPageValue("enttiyviews", $enttiyviews)



#set($entitymoduleviewid = $context.getRequestParameter("entitymoduleviewid"))

#ifnull($entitymoduleviewid)
	#set( $entitymoduleviewid = $userprofile.get("${module.id}_entitytabopen"))
#end
#ifnull($entitymoduleviewid)
	#set($entitymoduleviewid = $enttiyviews.first().getId())
#end

#ifnotnull($entitymoduleviewid)
		#set($entityviewdata = $mediaarchive.getCachedData("view", $entitymoduleviewid))
#end

$context.putPageValue("entitymoduleviewid", $entitymoduleviewid)
$context.putPageValue("entityviewdata", $entityviewdata)

#set($saveaction = $context.getRequestParameter("saveaction"))
#set($addnew = $context.getRequestParameter("addnew"))
#if ($addnew)

	#set($entitytabopen = $firstviewid)
#else
	##check if saveaction
	#if($saveaction == "upload")
		#set($entitytabopen = "tabimport")
	#end
#end

<div class="entitydialog #if($enablebackbutton || $addnew) enablebackbtn #end "
	##id="#eid($!dialogtabid)" 
	data-entityid="$!entity.id"
	data-entitymoduleid="$!entitymodule.id"
	data-entitymoduleviewid="$!entitymoduleviewid"
	data-oemaxlevel="1"
	data-url="${searchhome}/tabs/index.html"
	data-urlbar="$apphome/views/modules/$!{moduleid}/index.html?entityid=$!entityid"
	#if($entityhits && $entityhits.size() > 1)
		$context.putPageValue("hitssessionid", $entityhits.getSessionId())
		data-hitssessionid="$entityhits.getSessionId()" 
	#end
	#if($entity)
		data-setpagetitle="#text($entity)"
	#else
		data-setpagetitle="[[Add New]]"
	#end
	>

		$pages.include("${searchhome}/tabs/dialogheader.html", $context)
		
		$pages.include("${searchhome}/tabs/dialogtabbuttons.html", $context)
		
		#set($rendertype = $entityviewdata.rendertype)
		
		#ifnull($rendertype)
			#set($rendertype = "default")  
		#end
		
		#if($rendertype == "table")
			#set($rendertype = "tabsubmodulehome")
		#end
		
		<div class="entity-tab-content tabtype$!rendertype">
		
			#ifnull($entityviewdata)
				Please select a tab for $entitymoduleviewid		
			#end
			
			#ifnotnull($entityviewdata)
				$context.putPageValue("viewdata", $entityviewdata)
				$pages.include("${searchhome}/tabs/rendertypes/${rendertype}.html", $context)
			#end
		</div>
			
</div>
