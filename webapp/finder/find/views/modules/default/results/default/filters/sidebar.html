#set( $moduleid = $module.getId())
#set($preference = "minimize$!{moduleid}summary")
#set($issummaryminimized = $userprofile.getBoolean($preference))
#ifnull($issummaryminimized)
	#set($issummaryminimized = true)
#end

#set( $viewid = "$!{moduleid}advancedsearch")
$context.putPageValue("viewid",$viewid)

<div class="summary-container #if($issummaryminimized) closed #end"> 

	<div class="d-flex align-items-center justify-content-between h-row">
		<div class="summary-header summary-toggler" data-preferencename="$preference"> 
			<button class="btn"><i class="bi bi-chevron-right"></i></button>
			<h3>[[Summary]]</h3>
		</div>
		#if($caneditmetadatasetup)
			<a href="$applink/views/settings/modules/${moduleid}/metadata/viewssystem/dialog/index.html?viewid=$viewid"
				class="emdialog bg-brand summary-gear text-center"
				title="[[Customize Summary Contents]]"
				data-hidefooter="true"
				data-dialogid="summaryfilter">
				<i class="bi bi-pencil-square"></i>
			</a>
		#end
	</div>

	<div style="border-left:1px solid #e5e5e5">
		<div class="d-flex flex-column">
			#if($desktop)
				#set( $categorypath = $category.getCategoryPath() )
				#ifnotnull($categorypath)
					#set( $assetsource = $mediaarchive.getAssetManager().findAssetSource($!entity.get("uploadsourcepath")) )
					#ifnotnull($assetsource)
						#set($userlocaldesktoppath  = $assetsource.getConfig().get("userlocaldesktoppath"))
					#end
					<div class="p-2 bg-light">
						<span class="d-inline-block text-brand pb-1 w-100 showing">
							#set($categorybradcrumb = $categorypath.replace("/", " &rsaquo; "))
							<strong>Category Path</strong><br><span style="white-space: wrap;">#elidemiddle($categorybradcrumb, 100)</span>
						</span> 
						<div class="d-flex flex-column lightbox-header-btns py-2 ofl-path mx-auto"
							style="max-width: 180px;"
							data-moduleid="$!module.id"
							data-entityid="$!entity.getId()"
							data-path="$categorypath">

							#ifnotnull($userlocaldesktoppath)
								<button class="lightbox-header-btn open-folder" 
									data-root="${userlocaldesktoppath}">
									<i class="bi bi-eye-fill mr-1 ns"></i> <span>[[Open]]</span>
								</button>
							#end
							
							#ifnull($userlocaldesktoppath)
								#if($module.id!="faceprofilegroup" && $module.id!="modulesearch")
									<div class="d-flex flex-column">
										#if($permissions.canModule($module, "downloadall"))
										<button class="lightbox-header-btn download-lightbox positive" style="margin-bottom:6px">
											<i class="bi bi-cloud-arrow-down mr-1 ns"></i> <span>[[Download]]</span>
										</button>
										#end
										#if($permissions.canModule($module, "upload_folders"))
											<button class="lightbox-header-btn upload-lightbox" style="margin-bottom:6px">
												<i class="bi bi-cloud-arrow-up mr-1 ns"></i> <span>[[Upload]]</span>
											</button>
										#end
									</div>

									<div class="d-flex align-items-center">
										<button class="lightbox-header-btn open-folder flex-grow-1">
											<i class="bi bi-eye-fill mr-1 ns"></i> <span>[[Open]]</span>
										</button>
										<button class="lightbox-header-btn scan-changes px-2">
											<i class="bi bi-arrow-repeat ns m-0"></i>
										</button>
									</div>
								#end
							#end
						</div>
					</div>
				#end
			#end

			#set($totalResults = 0)
			
			#ifnotnull($hits)
				#set($currentpage = $context.getRequestParameter("currentpagenum"))
				#set( $prhits = $hits.getPositionRender() )
				#ifnotnull($currentpage)
					$prhits.setPageOneBased($currentpage)
				#end
		
				#set( $selectedpos = $prhits.toPosition($prhits.getPage()))
		
				#set($totalResults = $hits.size())
		
				#set( $hitsPerPage = $hits.getHitsPerPage())
				#set($showingFrom = ($selectedpos - 1) * $hitsPerPage)
				#set($showingTo = $showingFrom + $hitsPerPage)
		
				#if($showingTo > $totalResults)
					#set($showingTo = $totalResults)
				#end
				
				#set($showingFrom = $showingFrom + 1)
			#end
			<div class="px-2 pt-1">
				<span class="d-inline-block text-brand pb-1 w-100 showing" >
					<strong>#text($module)</strong> <span>($totalResults)</span>
				</span>
				#if($totalResults> 0 )
					#if($resultview != "stackedgallery" && $resultview != "brickvertical")
						<span   class="d-inline-block text-brand pb-1 w-100 showing">
							[[Showing]] <strong>$showingFrom</strong> &mdash; <strong>$showingTo</strong>
						</span>
					#else
						<span class="d-inline-block text-brand pb-1 w-100 showing">
							[[Showing]] <strong>$totalResults</strong>
						</span> 
					#end
				#end

				#set ($currentSort = $hits.searchQuery.getSortByDetail() )
				#if($hits.searchQuery.isSortUp())
					#set($sortOrder = "asc")
				#else
					#set($sortOrder = "desc")
				#end
				#ifnotnull($currentSort)
				<span class="d-inline-block text-brand pb-1 w-100 showing">
					[[Sorted by]] <a href="$searchhome/filters/dialogsort.html" 
					class="emdialog emsort #if($selectedpreference) closed #end text-success"
					data-dialogid="sortdialog"
					data-hidebackdrop="true"
					data-hidefooter="true"
					data-modalsize="sm"
					data-includesearchcontext="true"						
					data-includeeditcontext="true"
					style="padding:0 4px 1px;" 
					title="[[Sort Results]]">#text($currentSort)</a> (${sortOrder}.)
				</span>
				#end 
	
				#ifnotnull($entity)
					###set($desc = $entity.get("longcaption"))
					#ifnotnull($desc)
					<p class="text-brand pt-1 mb-0 border-top">
						<strong>[[Description]]:</strong>
						<span class="trim-text" data-max="150">$desc</span>
					</p>
					#end
				#end
			</div>
		</div>
	</div>

	<div class="summary-container-filters">
		<div class="col-sidebar-scroll overflow-y">

		$pages.include("${searchhome}/filters/index.html", $context)
		
		## ENTITIES EXTRA
		#if($canviewentitiesbreadcrumb && $moduleid == "asset")
			#set( $entities = $userprofile.getEntitiesInParent($category) )
			#if($entities && $entities.size() > 0)
				<div class="filter-box">
					<div class="filter-box-header">
						<div class="d-flex align-items-center toggle-filter sidetoggle flex-grow-1" data-target="searchfilterboxrelatedentity">
							<span class="mr-2">
								<i class="caret bi bi-caret-right-fill exp"></i>
							</span> 
							<p class="m-0 flex-grow-1">[[Related Entity]]</p>
						</div>
					</div>
					<div class="filter-box-options overflow-y" id="searchfilterboxrelatedentity">
						<div class="category-entities-actions">
						#foreach ( $data in $entities)
							#set($entity = $data.getData())
							#set($entityid = $data.getId())
							#set($emoduleid = $data.getModuleId()) 
							
							#set($emodule = $mediaarchive.getData("module", $emoduleid))
							
							#set($rendertype = $emodule.modulerendertype)
							#if (!$rendertype)
								#set($rendertype = "entity")
							#end
							$context.putPageValue("rendertype", $rendertype)
							$context.putPageValue("rendermoduleid", $emoduleid)
							
							#set($moduleicon = "entity")
							#if ($emodule.moduleicon)
								#set($moduleicon = $emodule.moduleicon)
							#end
								
							#set($previewurl = "$!{siteroot}$apphome/views/modules/$!{emoduleid}/editors/default/tabs/index.html?entityid=$entity.getId()")
							
							$context.putPageValue("hit", $entity)
							
							#set($moduleicon = "entity")
							#if ($module.moduleicon)
								#set($moduleicon = $module.moduleicon)
							#end
							
							<div class="category-entity">    	
								<a href="$previewurl" 
								class="emdialog entity-dialog emgridresulttitle" 
								id="clickid${entityid}"  
								data-id="${entityid}"
								data-moduleid="$!emoduleid"
								title="#text($!entity)">
								<i class="bi bi-folder-fill"></i>&nbsp;#text($emodule) \ #text($entity)</a>
							</div>
						#end
						</div>
					</div>
				</div>
			#end
		#end
		</div>
		
		
	</div>
</div>
