#if(!$moduleid)
#set( $moduleid = $context.getRequestParameter("moduleid"))
#end
#if(!$entityid)
#set( $entityid = $context.getRequestParameter("entityid"))
#end


##set( $existingcategories = $mediaarchive.query("category").hitsPerPage(6).match($moduleid, $entityid).sort("name").search($context) )
#if($moduleid && $entityid)
	#set( $existingcategories =  $mediaarchive.getBean("entityManager").loadCategories($moduleid, $entityid))
#end

#set($existingids = [])
#foreach ($c in $existingcategories)
	#set($null = $existingids.add($c.getId()))
#end
<div id="entitycategoryresults#eid($entityid)" class="entity-media-box #if(!$existingcategories) collapsedmediabox #end" style="margin-bottom:20px;">
<div  class="entitycategoryresults  " >


			
			
			#set($uploadsourcepath =  $mediaarchive.getBean("entityManager").loadUploadSourcepath($module,$entity, $context.getUser()))
			#if(!$uploadsourcepath)
				#set($uploadsourcepath = "Albums/Users/$user.getScreenName()/Desktops")
			#end
			
			--
			$uploadsourcepath

	<div class="entity-media-header">
		<h4 class="expandmediabox">
		#if(!$existingcategories)
			<i class="fas  fa-caret-right  expandmediaboxicon"></i>
		#else
			<i class="fas  fa-caret-down  expandmediaboxicon"></i>
		#end [[Folders]]</h4>
		
		
		#if($moduleid && $entityid)
			
			

			#if($desktop)
				<a  
				href="#" 
				id="localfolderPicker"
				class="localfolderPicker" 
				data-sourcepath="$uploadsourcepath"
				data-moduleid="$moduleid"
		   		data-entityid="$entityid"
				class="entity-add-media"
				title="[[Upload Folder]]">
				<i class="fas fa-upload"></i></a>
			#else
				#set($uploadlink = "$siteroot$applink/views/modules/asset/add/start.html?entityupload=true&entitytype=$moduleid&addselection=$entityid&clearotherentities=true")
				#set($oemaxlevel = "1")
				#set($targetdiv = "applicationmaincontent")
				<a href="$uploadlink" 
					class="ajax entity-add-media"
					data-targetdivinner="$targetdiv"
					data-closedialog="true" 
					data-closemediaviewer="true"
					data-updateurl="true"
					data-oemaxlevel="$!oemaxlevel"
					title="[[Upload Folder]]">
					<i class="fas fa-upload"></i></a>
			#end
			
			#set($searchlink = "$apphome/components/categories/search/searchcategory.html")
			<a href="$searchlink" 
			   class="detail-edit-icon btn emdialog"
			   data-dialogid="categorypickermodule"
			   data-cancelsubmit="true" 
			   data-multivalue="false"
			   data-pickone="true"
			   data-moduleid="$moduleid"
			   data-entityid="$entityid"
			   data-existingcategories="$!{existingids}"
			   data-pickedcategoryaction="$apphome/components/categories/entities/listcategories.html"
			   data-targetdiv="entitycategoryresults#eid($entityid)"
			   data-parameterdata="id"
			   data-noesc="true"
			   title="[[Choose Folder]]"><i class="fas fa-search"></i></a>
	   #end	
	   
	</div>
	
	

		<div  id="cat-list" class="emlist">
		<table style="width:100%;">
		#foreach ($c in $existingcategories)
		
			##better way to do this?
			#set ($category = $mediaarchive.getCategory($c.getId()))
			
			 
			#set( $iscollection = $categoryCollectionCache.isPartOfCollection($category))
			
			
			<tr>
			<td>
				<div  class="list-row">
				<div  class="category #if($iscollection) cat-collection #else cat-category #end">
				#foreach( $parent in $category.getParentCategoriesFrom(1))
					#if( ${foreach.count} > 1)\
					#end
					<a style="padding:0px 0 4px 0;" 
						##class="emdialog entity-dialog"
						##data-targetdiv="entitypreviewdialog"
						##data-entityid="${parent.id}"
						##href="$home$apphome/components/gridsample/preview/entity.html?searchtype=category&id=${parent.id}">
						
						href="views/modules/asset/bycategory/${parent.id}.html">$parent</a>
				#end
				</div>
				</div>
			</td>
			<td style="width:30px; text-align: right; vertical-align: top; padding:6px 2px 0 0;">
			#if($desktop)
				<a href="" 
					class="folderdesktopdownload"
					data-categoryid="$c.getId()"
					title="[[Download Folder]]">
					<i class="fas fa-download"></i></a>
			#else
				#if( $caneditassetcategories )
				 	<a class="ajax list-delete"  
				 		data-targetdiv="entitycategoryresults" 
				 		href="$!home$apphome/components/categories/asset/removeassetcategory.html?assetid=${asset.id}&categoryid=${category.id}" >
				 	<i class="fas fa-times"></i></a>
			 	#end
		 	#end
			</td>
			</tr>
			
			
			
			
		#end
		</table>
		</div>
	</div>
</div>