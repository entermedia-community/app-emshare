#set($popupheight = 10)

#if($livesuggestions.size())
	#set($popupheight = $popupheight+50)
#end
#if($topichits.size())
	#set($popupheight = $popupheight+60)
#end

#set( $moduleid = $context.getRequestParameter("moduleid") )

#set( $url = "$applink/views/modules/asset/index.html")

#set($ajax = $context.getRequestParameter("ajax")) 

<div style="position:absolute;top:4px;right:8px;color:#333;font-size:1rem;z-index:1000;">
	<span title="[[Esc to Close]]" class="bi bi-x-circle closemainsearch"></span>
</div>

<div class="quicksearchresults">
	<div id="searchLoading">
		<div class="d-flex flex-column align-items-center">
			<div class="lds-dual-ring"></div>
			<div class="loading-text">[[Searching for results]]</div> 
		</div>
	</div>


#ifnull($hits)
	#set($hits = $organizedResults.getEntityHits() )
#end

#set( $input = $hits.getSearchQuery().getMainInput())
#if (!$input)
	#set( $input = "")
#end

#set( $input = $url_util.decode($input) )

#if($organizedResults.isEmpty())
	<div class="text-secondary py-3 text-center">
		[[No exact match found for]]: <strong>$input</strong>
	</div>
#end

#ifnull($hits)
	<div class="startsearch">[[Start typing to search]]</div>
	<div class="quicksearchmodules">
  	#foreach ( $amodule in $userprofile.getSearchableEntities() )
  		#set($amoduleid = $amodule.getId())
	  	#if($amoduleid!="modulesearch")
	  		#set($entityrendertype = "entity")
			#if ($amodule.modulerendertype)
				#set($entityrendertype = $amodule.modulerendertype)
			#end
			#set($moduleicon = "grid")
			#if ($amodule.moduleicon)
		   		#set($moduleicon = $amodule.moduleicon)
		   	#end
	   	
	 		#set($entityurl = "$!siteroot$apphome/views/modules/$!{amodule.id}/index.html")
	 		<div class="qsmodule">
	    	<a class=""
	    		title="[[View]] #text($amodule)" 
	    		href="$entityurl" >
	    		<div class="p-2"><i class="bi bi-$!{moduleicon} module-icon" style="font-size:3em;line-height:1;opacity:0.85;"></i> </div>
	    		#text($amodule)</a>
	    	</div>
	    #end
    #end
    </div>
#end

#if(!$livesuggestions.isEmpty())
<ul class="qsrecent">
#foreach ($suggestion in $livesuggestions)
	#set($highlighted = $highlighter.highlight($livesearchfor, $suggestion, 20, true))
	#ifnotnull($highlighted)
	<li class="lisuggestion">
		<a href="#" class="qssuggestion" data-suggestion="#esc($suggestion)">$highlighted</a>
	</li>	 
	#end
#end
</ul>
#end

#foreach($module in $organizedResults.getModules() )
	#set($hits = $organizedResults.getByType($module.id,$context))
	#ifnotnull($hits)
		$context.putPageValue("module", $module)
		$context.putPageValue("moduleid", $module.id)
	
		#set($moduleicon = "grid")
		#if ($module.moduleicon)
			#set($moduleicon = $module.moduleicon)
		#end
		   	
		#set($entityurl = "$!siteroot$apphome/views/modules/$!{module.id}/index.html?$!{module.id}page=1&field=description&operation=freeform&description.value=$input")
			
		<div class="mb-4">
			
			<div class="mt-2 qsresultsEntity d-flex align-items-center">
				<i class="bi bi-$moduleicon module-icon"></i>
				<span class="qsresultsEntitytext">#text($module)</span>

				#set( $count = $organizedResults.getCount($module)) 
				#if($count > 10)
				<span class="mx-1">&middot;</span> 
				<a href="$entityurl" 
					class="ajax qsresultsEntityall btn btn-sm btn-accent" 
					data-targetdiv="applicationmaincontent" 
					data-oemaxlevel="3" 
					data-updateurl="true" 
					title="[[View]] $count: #text($module)">
					<span class="qsresultsEntitytext">
						[[View]] $count
					</span>
				</a>
				#end
			</div>

			
		   $context.putPageValue("rendermoduleid", $module.id)
			   			   
		   $hits.setHitsPerPage(10)
		   $context.putPageValue("hits", $hits)
		   
		   $context.putPageValue("searchresults", true)
		   $context.putPageValue("searchhome", "$apphome/views/modules/${module.id}/results/default")
			
			<div class="emgridflex">  	
				<div id="galleryimg-entitiy" 
					class='emgrid #if($section != "favorites")emgridlimited#end entitiescontainer emgridquickresults' 
					style="width:100%"
					data-fixedwidth="180" 
					data-cellpadding="10"
					data-entityrenderurl="$!{siteroot}$apphome/views/modules/${module.id}/editors/default/tabs/gridcell.html"
					data-rendertype="$!rendertype">
					#set($detail = $mediaarchive.getSearcher($module.id).getDetail("primarymedia"))
					#set($viewtype = "primarymediafolder")
					$context.putPageValue("viewtype", $viewtype)
					#foreach( $hit in $hits.getPageOfHits() )
						$context.putPageValue("hit", $hit)
						#set($rendertype = $module.modulerendertype)
						#if (!$rendertype)
							#set($rendertype = "entity")
						#end
						<div class="emgridcell emgridcellqs emgridcell-$rendertype activelistcontainer #if($selectedid == $hit.getId() || $topselectedid == $hit.getId()) active #end">
							
							$pages.include("$apphome/views/modules/$!{module.id}/components/xml/detailreadonly.html", $context)
						
							#set($highlight =  $hits.highlight($hit, "description", 20, true))
							#if($highlight)
							<div class="gridcellhighlight">$highlight</div>
							#end
						</div>
					#end
				</div>
			</div>
		</div>
	#end
#end

#if($organizedResults.getAssetHits() )

	#set($assetmodule = $mediaarchive.getCachedData("module","asset"))

	#set($moduleicon = "grid")
	#if ($assetmodule.moduleicon)
		#set($moduleicon = $assetmodule.moduleicon)
	#end

	#set($hits = $organizedResults.getAssetHits() )

	#set($edithome = "$apphome/views/modules/asset/editors/quicksearch")
	#set($entityurl = "${edithome}/index.html?search=$input")

	#set( $count = $hits.size())
	<div class="mt-2 qsresultsEntity d-flex align-items-center">
		<i class="bi bi-$!{moduleicon} module-icon" style="font-size:0.9em;line-height:1;opacity:0.85;"></i>  
		<span class="qsresultsEntitytext">#text($assetmodule)</span>

		#if($count > 10)
		<span class="mx-1">&middot;</span>
		<a href="$entityurl" 
			class="ajax qsresultsEntityall btn btn-sm btn-accent"
			data-targetdiv="applicationmaincontent" 
			data-oemaxlevel="2" 
			data-updateurl="true" 
			title="[[View]] $count: #text($assetmodule)">
			<span class="qsresultsEntitytext">[[View]] $count</span>
		</a>
		#end
	</div>
	
	<div class="masonry-grid" 
		data-maxheight="240" 
		data-cellpadding="10"
		data-makebox="true"
		data-visibleposition="$!hits.getStartingPosition()">
		#set($count = 0)
		
		#foreach( $hit in $hits.getPageOfHits() )
			#if($count < 30)
				$context.putPageValue("hit", $hit)
		    $pages.include("${searchhome}/types/media.html", $context)
		    #set($count = $count +1)
		  #end
		#end

		#if($hit.getPageOfHits().size() == 0)
			$pages.stream("$!{searchhome}/empty.html", $context)
		#end
	</div>
#end


<div id="semanticLoading"></div>
<div id="semanticMatches" class="mt-3 mx-1"></div>

</div>