<div class="ui-widget uipanel" id="entitypicker">
    <div class="ui-widget-header">[[Data Entity Tags]]
    	<span class="widget-header-edit">
		 <a	class="ajax" 
			data-targetdivinner="applicationmaincontent" 
			data-oemaxlayout="3" 
		 href="$applink/views/settings/modules/asset/metadata/views/index.html?viewid=multipleupload&amp;viewpath=asset/multipleupload" title="Edit"><i class="fas fa-cog"></i></a>
		</span>
    </div>
    
	#set( $others = [])
	#set( $type = $context.getRequestParameter("entitytype") )		##TODO remember the last selected	 
	#foreach ( $amodule in $userprofile.getEntities() )
		#set( $hits = false )
		#if( $amodule.id != "asset" && $amodule.id != "faceprofilegroup" )
			#set( $key = "picked$amodule.getId()" )
			#set( $hits = $userprofile.getValues($key))
			#if( ($type && $amodule.id == $type  ) || ( $hits) )
			
			#else
				#set( $true = $others.add($amodule) )
			#end	
		#end
	#end
	
	
    <div style="padding:15px 0"> 
		
		    
			#if( !$others.isEmpty() )
				<div style="margin-bottom:15px;">
					<select name="addentity" 
							class="ajaxautosubmitselect form-control form-control-sm" 
							data-url="$applink/components/upload/entities/picker.html" 
						data-parametername="entitytype" 
						data-targetdiv="entitypicker" data-oemaxlevel="1" >
							<option >[[Add Entities]]</option>
						#foreach ( $amodule in $others )
							<option value="$amodule.id">$amodule.getName($context)</option>
						#end
					</select>
					<div class="clearfix"></div>
					</div>
			#end
		
			#set($clearotherentities = $context.getRequestParameter("clearotherentities") )
			#set($addselection = $context.getRequestParameter("addselection") )
			
				#foreach ( $amodule in $userprofile.getEntities() )
					<div  class="row no-gutters">
					#set( $hits = false )
					#set( $key = "picked$amodule.getId()" )
					#set( $hits = $userprofile.getValues($key))
					#if( ($type && $amodule.id == $type  ) || ( $clearotherentities !="true" && $hits && $amodule.id != "asset" && $amodule.id != "faceprofilegroup") )
						<div class=" col-5">
						<div class="side-select-menu #if( $type == $amodule.id) active #end"> 
						
						<div class="addMediaRow">
						<a class="ajax" data-targetdiv="entitypicker" data-oemaxlevel="1"  
						href="$siteroot$applink/components/upload/entities/picker.html?entitytype=${amodule.id}&clearotherentities=$!clearotherentities"> 
								<h5 class="selectedEntity" style="padding: 10px 0px 10px 10px;">$amodule</h5>
						</a>
						</div>
						
						<input type="hidden" name="field" value="$amodule.id" />
						#if( $hits && !$hits.isEmpty() )
							<div class="addEntityButtonContainer" style="padding:  0 0 10px 10px">
							#foreach( $id in $hits )
								#if($id == $addselection || $clearotherentities != "true")
									#set( $data = $mediaarchive.getCachedData($amodule.getId(),$id))
									<a class="badge badge-secondary ajax" style="margin:4px;" 
										data-targetdiv="entitypicker" 
										data-oemaxlevel="1" 
										href="$siteroot$applink/components/upload/entities/picker.html?entitytype=$amodule.getId()&removeselection=$id&clearotherentities=$!clearotherentities">
									<input type="hidden" name="${amodule.id}.value" value="$id" />
									#text($data) <i class="fas fa-times"></i>
							 		</a>
							 	#end
					 		#end
				 			</div>
			 			#end
						</div>
						</div>
						#if( $type == $amodule.id )
							<div class="col-7">
							<div class="addEntity">
								
									<a class="ajax addEntityClose" 
									style=" " data-targetdiv="entitypicker" data-oemaxlevel="1" 
									href="$applink/components/upload/entities/picker.html?&clearotherentities=$!clearotherentities"> <i class="fas fa-times"></i></a>
									
								
							
							#set($entries = false)
							#set($entries = $mediaarchive.getList($type))
							#set( $hits = false)
							#set( $key = "picked$type" )
							#set( $hits = $userprofile.getValues($key))

							<div class="addEntityButtonList" style="">
							#foreach($item in $entries)
									#if( !$hits.contains($item.getId()) || ($clearotherentities == "true" && $item.getId()!=$addselection))
									<a class="badge badge-secondary ajax" style="margin:4px;" data-targetdiv="entitypicker" data-oemaxlevel="1" 
										href="$applink/components/upload/entities/picker.html?entitytype=$type&selected=$!selectedtext&addselection=$item.getId()&&clearotherentities=$!clearotherentities">
										<i class="fas fa-angle-double-left"></i> $item </a>
									#end
									
							#end
							</div>
							<a class="btn btn-xs btn-dark  emdialog TODOautocloseside addEntityButton" 
										style=""  data-hidefooter="true" 
										href="$applink/components/upload/entities/addnewentity.html?viewid=${type}addnew&searchtype=$type&&clearotherentities=$!clearotherentities">
										<i class="fas fa-plus"></i> [[Add New]] </a>
							</div>
							</div>
						#end
						
					#end
					</div>
				#end
	 		

 </div>  ##dialog
	
</div>  ##panel