#set( $moduleid = $module.getId())

#if ($editfilters)
	#set( $edit = true )
#elseif( !$editfilters)
	#set( $edit = $context.getRequestParameter("editfilters"))
#end
#if( $edit)
	$context.putPageValue("edit",$edit)
#end

#if( !$librarycol )
	#set($collectionid = $context.getRequestParameter("collectionid"))
	#if($module=="librarycollection" && $collectionid)
		#set( $librarycol = $mediaarchive.query("librarycollection").exact("id",$collectionid).searchOne() )
	#end
#end

#if( $librarycol )	
	$context.putPageValue("librarycol",$librarycol)
	$context.putPageValue("collectionid", $librarycol.getId())
#end

#if(!$categoryid)
	#set($categoryid = $context.getRequestParameter("categoryid"))
#end


#set($targetdivsearch = $context.getRequestParameter("targetdivsearch"))
#ifnull($targetdivsearch)
	#set($targetdivsearch = "$!{moduleid}resultscontainerembed")
#end


<div id="moduleadvfilterpanel" class="advfilterpanel" >

	<div class="advfilterpanelcontent" >
		#set( $view = "$moduleid/$!{moduleid}advancedfilter")
	
		#set( $searcher = $mediaarchive.getSearcher($moduleid))
		
		$context.putPageValue("view", $view)
		$context.putPageValue("searcher", $searcher)
		
		#set($usestartswith = $page.isPropertyTrue('usestartswith'))
		$context.putPageValue("usestartswith",$usestartswith)
		$context.putPageValue("caneditlists",false)
		
		
		#set( $targetmodule = $context.getRequestParameter("targetmodule"))
	
		#if(!$topmoduleid)
			#set ( $topmoduleid = $context.getRequestParameter("topmoduleid") )
		#end
	
	
	
	
	<form  	name="filterform" 
			id="filterform" 
			class="ajaxform autosubmitform filterform"
			method="POST" 
			data-targetdiv="$targetdivsearch" 
			data-oemaxlevel="1" 
			data-closedialog="true"
			data-updateurl="false"
			#if($topmoduleid)
			action="$siteroot$apphome/views/modules/$moduleid/dialogindex.html"
			#else
			action="$siteroot$apphome/views/modules/$moduleid/index.html"
			#end 
	>
		
		##<input name="searchtype" type="hidden" value="$!moduleid" />
		<input name="hitssessionid" type="hidden" value="$!hits.getSessionId()" />
		<input type="hidden" name="$!{moduleid}endusersearch" value="true" />
		#if($topmoduleid)
			<input name="topmoduleid" type="hidden" value="topmoduleid" />
			<input name="dialogresults" type="hidden" value="true" />
		#end
		#if($categoryid)
			<input name="categoryid" type="hidden" value="$categoryid" />
		#end
		#set($rootcategory = $context.getRequestParameter("rootcategory"))
		#if($rootcategory)
			<input name="rootcategory" type="hidden" value="$rootcategory" />
		#end
		
		#if( $librarycol)
			<input name="collectionid" type="hidden" value="$!librarycol.getId()">
		#end
		
		##We need 2 things passed in: $searcher, $view or $searcher $details
	
		#if (!$details && $userprofile)
			#set ($details = $searcher.getDetailsForView($view, $userprofile))
		#else
			#set ($details = $searcher.getDetailsForView($view))
		#end
		
		$context.putPageValue("idprefix","entitysearch")
	
		## Open search?
		#if( $hits.getSearchQuery().hasMainInput())
		#set($currentsearch = $hits.getSearchQuery().getMainInput())
		#end
		<div style="padding:10px 0 20px">
		<div class="form-group" style="    margin: -10px; padding: 15px;    background-color: #d1d1d1d1;">
			<input name="field" value="description" type="hidden">
			<input name="operation" value="freeform" type="hidden">
			<div class="filter-box">
				<div class="filter-box-options filterbox-mainsearch" id="filterboxdescription" style="position:relative">
						
						#set( $detailid = "description" )
						
						##TODO Use $values
						#set( $vals = $currentsearch.split("\s*\|\s*") )
						
						<select name="${detailid}.value" 
								id="$!{idprefix}list-${detailid}0value" 
								multiple="multiple" 
								class="searchtags filterstags "
								data-url="$componenthome/xml/types/autocomplete/tagsearch.txt" 
								data-searchfield="$detailid"
								data-sortby="" 
								data-placeholder=""
						        data-width="100%"
								>
							#foreach($vtag in $vals)
								#if($vtag && $vtag != "")
									<option value="$!vtag" selected="selected">#esc($vtag)</option>
								#end
							#end
							#if( $foundrow )
							  <option value="$!val" selected="selected">#esc($label)</option>
							#end
						</select>
					
						#if($moduleid=="asset")
							#if(!$dialogresults)
								#set($dialogresults = $context.getRequestParameter("dialogresults"))
							#end
							#if($dialogresults)
								#set($href = "$siteroot$apphome/views/modules/$moduleid/dialogindex.html?hitssessionid=$!hits.getSessionId()&topmoduleid=$!topmoduleid&rootcategory=$!rootcategory&categoryid=$!{categoryid}&removeterm=description")
							#else
								#set($href = "$siteroot$apphome/views/modules/$moduleid/index.html?hitssessionid=$!hits.getSessionId()&topmoduleid=$!topmoduleid&rootcategory=$!rootcategory&categoryid=$!{categoryid}&removeterm=description")		
							#end
							#set($oemaxlevel = "1")
						#else
							#set($href = "$siteroot$apphome/views/modules/$moduleid/index.html?hitssessionid=$!hits.getSessionId()&removeterm=$!term.getId()")
							#set($oemaxlevel = "1")
						#end
						
						
						
						<a href="$href" 
							class=" ajax clearfiltersearch"
							
							title="[[Clear]]: #esc($hits.getSearchQuery().getMainInput())"
							data-targetdiv="$!targetdiv" 
							data-oemaxlevel="$oemaxlevel"
							data-updateurl="false" 
							style="    
								position: absolute; top: 5px;    right: 10px;
								display:none; #if($currentsearch)	display:block;	#end"><i class="fas fa-times"></i></a>
					
				</div>
			</div>
		</div>
		</div>
		
		
	
		##FILTERS
		#foreach( $detail in $details)   
			#set( $viewpermission = $context.getPageValue("canviewfilter${detail.getId()}") )
			##ifnull($viewpermission)
				#set( $viewpermission = true)
			##end
			
			  #if( $viewpermission )
				$context.putPageValue("detail", $detail)
				$context.putPageValue("searchform", true)

				#if ($detail.isLeaf())
					##if ($detail.isFilter())
					##end
					
					#set($filternode = $hits.findFilterValue($detail.id))
					
					$context.putPageValue("filternode",$filternode)
					
					
					
					#if(($edit == "true") || $filternode)
					
						##if(!$filternode.isEmpty() && $filternode.children.size() > 1)
							$pages.include("/${applicationid}/components/filters/detailedit.html", $context)
						##end
					#else
						$pages.include("/${applicationid}/components/filters/detailedit.html", $context)
					#end	

					
						
				#else($detail.hasChildren())
					$pages.include("/${applicationid}/components/filters/section.html", $context)
				#end
			  #end
		#end
	
		<input type="hidden" name="customproperty" value="userinputsearch"/>
		<input type="hidden" name="userinputsearch.value" value="true"/>
		<input type="hidden" name="removeterm" id="filtersremoveterm" value=""/>
			
		#set ($resultview = $userprofile.get('resultview'))
		#if( !$resultview )
		<input type="hidden" name="resultstype" value="table" />
		#end
		##<input type="button" class="btn btn-sm btn-primary" value="[[Close]]">
		
	</form>
	
	
		
	#if(!$edit)	
		
	##SORT
	<form  	name="filtersortform" 
			id="filtersortformdialog" 
			class="filterform ajaxform"
			method="POST"   
			data-targetdivinner="$targetdivsearch" 
			data-oemaxlevel="2" 
			action="$siteroot$apphome/views/modules/$moduleid/components/results/columnsort.html" 
		>
		#if($topmoduleid)
		<input name="topmoduleid" type="hidden" value="$topmoduleid" />
		<input name="dialogresults" type="hidden" value="true" />
		#end
		
		<input name="searchtype" type="hidden" value="$!moduleid" />
		<input name="hitssessionid" type="hidden" value="$!hits.getSessionId()" />
		#if($categoryid)
			<input name="categoryid" type="hidden" value="$categoryid" />
		#end
		#if( $librarycol)
			<input name="collectionid" type="hidden" value="$!{librarycol.getId()}" />
		#end
		

		
		
		<div class="form-group" style="margin:15px 0;">
			<div class="filter-box" style="display:flex;">
				<div class="filter-box-header" style="line-height: 1.65; padding-right: 6px;">[[Sort]]:</div>
			
			<div class="filter-box-options" 
				 id="filterboxsorting"
				 style="width:255px; padding-right:6px">
				#set ($alldetails = $searcher.getUserPropertyDetails() )
				<div >
				<select data-sortup="$hits.searchQuery.isSortUp()" 
						class="form-control  select2 autosubmited" 
						name="sortby" 
						id="$!{moduleid}dialogsortby" 
						data-allowclear="false" 
						style="" >
					#foreach( $detail in $alldetails)
						
						 #if($hits.searchQuery.isSortUp())
						 	#set($value = "${detail.id}Up")
						 	#set($currentSortOrder = "up")
						 #else
						 	#set($value = "${detail.id}Down")
						 	#set($currentSortOrder = "down")
						 #end
						<option data-detailid="${detail.id}" 
								value="$value" 
								#if($hits.isSortedBy($detail.id)) 
									selected="selected" 
									#set($currentSort = $detail.getText($context))
								#end>$detail.getText($context)</option>
					#end
				</select>
				
				</div>
				</div>
				<div class=" " >
				<a href="#" 
					class="filterschangesort"
					data-sortbyfield="${moduleid}dialogsortby" 
					title='[[Sort by]] $currentSort #if($currentSortOrder == "up") [[Down]] #else [[Up]] #end'>
					<i class=" fas #if($hits.searchQuery.isSortUp()) fa-sort-alpha-down #else fa-sort-alpha-up #end" style="padding-top:5px"></i>
				</a>
				</div>
				
			
		</div>
		</div>
	</form>	
	
	#end
	
	

		
		
	##EDITING
		
		#if ($edit == "true")
			##TODO: Pass this view name in
			#set ($alldetails = $searcher.getUserPropertyDetails() )
			<div class="advancedsearcheditform">
			<strong style="margin-bottom:10px;display:block">[[Add Filters]]:</strong>
			<form id="searchaddfield" 
				class="ajaxform" 
				data-targetdiv="moduleadvfilterpanel" 
				action="$siteroot$apphome/views/modules/$moduleid/components/filters/addfield.html" 
				method="post">
				<input type="hidden" name="dialogfilters" value="true"/>
				<input type="hidden" name="oemaxlevel" value="1"/>
				<input type="hidden" name="editadvsearch" value="true"/>
				<input type="hidden" name="view" value="$view"/>
				<input type="hidden" name="catalogid" value="$searcher.getCatalogId()"/>
				<input type="hidden" name="collectionid" value="$!collectionid"/>
				<input type="hidden" name="categoryid" value="$!categoryid"/>
				<input type="hidden" name="moduleid" value="$!moduleid"/>
				<input type="hidden" name="searchtype" value="$searcher.getSearchType()"/>
				<div class="form-group">
				<select  class="form-control"  name="field" onChange="jQuery('#searchaddfield').submit();">
					<option value="">#text($module)</option>
					#foreach( $detail in $alldetails)
						#if($detail.isLeaf())
						<option value="$detail.id" style="margin-left: 10px;">$detail.getText($context)</option>
						#else							
							<optgroup label="$detail.title"></optgroup>
							#foreach($child in $detail)
							<option value="$child.id" style="margin-left: 10px;">$child.getText($context)</option>
							#end
						#end
					#end	
				</select>
				</div>
				
					
				<div class="form-group">
					###set($doneUrl = "$siteroot$componenthome/filters/index.html?oemaxlevel=1&collectionid=$!collectionid&moduleid=$!moduleid")
					
					#set($doneUrl = "$siteroot$componenthome/filters/dialog.html")
					<a class="btn btn-sm btn-secondary ajax"  
						data-targetdiv="moduleadvfilterpanel" 
						data-oemaxlevel="1" href="$doneUrl">[[Done Editing]]</a>
				</div>	
			</form>
			</div>
		#end
	
		<script type="text/javascript">
			deleteFilterField = function(inType,inFieldId)
			{	
				var params = 'dialogfilters=true&oemaxlevel=1&editfilters=true&collectionid=$!collectionid&view=$view&catalogid=$searcher.getCatalogId()&searchtype=' + inType + "&field=" + inFieldId+"&moduleid=$!moduleid";
				jQuery('#moduleadvfilterpanel').load("$siteroot$componenthome/filters/deletefield.html?" + params)
			}
		</script>
	</div>
	
		#if( !$edit )
		<div class="filters-edit-icon float-right">
			<a class="ajax btn btn-sm btn-secondary" data-targetdiv="moduleadvfilterpanel" 
				href="$!siteroot$apphome/views/modules/$moduleid/components/filters/dialog.html?editfilters=true&oemaxlevel=1&collectionid=$!collectionid&moduleid=$!moduleid"
				title="[[Add Filters]]">
				<i class="fas fa-plus"></i> [[Filters]]</a>
		</div>
	#end
	
	
	<a href="" title="[[Close Filters]]" class="btn btn-sm btn-primary" data-dismiss="modal">[[Close]]</a>
	
</div>