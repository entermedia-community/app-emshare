#set($section = $content.get("section"))
#set($filter = $modulehits.findFilterValue("entitysourcetype") )

#if( $organizedModules.isEmpty())
	<div>[[0 results]]</div>
#end

#foreach($module in $organizedModules)
	
	#set($idhits = $organizedHits.get($module.id))
	
	$context.putPageValue("hits", $idhits)
	$context.putPageValue("module", $module)
	$context.putPageValue("moduleid", $module.id)
	
   	#set($rendertype = "entity")
   	#if ($module.modulerendertype)
   		#set($rendertype = $module.modulerendertype)
   	#end
   	$context.putPageValue("rendertype", $rendertype)
   	
   	
   	#set( $favorites = $userprofile.get("favorites_"+$module.id))
	$context.putPageValue("favorites", $favorites)
    	
   	#if( $rendertype == "media")
   		##Stacked view
   		<div class="emgrid-module emgrid-module-$rendertype">
   			<div id="resultsdiv" 
   				data-hitssessionid="$idhits.getSessionId()" ##it breaks drag&drop
   				#set( $inputid = $context.getRequestParameter("inputid"))
   				data-inputid="$!inputid"
   				data-ismaingrid="true"
   				>
	   		<div class="emgrid-module-$rendertype-inside">
	   		
	   			$pages.include("$apphome/components/results/header.html?ismaingrid=true",$context)
	   		
		   		$pages.include("$apphome/components/gridsample/types/media.html", $context)
		   		
		   		
		   		<div class="clearfix"></div>
		   		
		   		
		   		#set($resultsPage = "$siteroot$apphome/views/modules/$module.id/index.html")
				#if($idhits.size() > 4 && $section != "favorites")
					#if( $jsonsearch)
						#set($resultsPage = $url_util.urlEscape("$resultsPage?${module.id}clearfilters=true&${module.id}_jsonquery=$jsonsearch" ) )
					#end		
					<div class="emgrid-seemore"><a href="$resultsPage">[[See More]]</a></div>
					<div class="clearfix"></div>
				#end
			</div>
			</div>
   		</div>
   		
   	#else
   		<div class="emgrid-module emgrid-column emgrid-module-$rendertype">
   		<div class="emgrid-subtitle">
   		<h3>
	     	#set($moduleicon = "entity")
	     	#if ($module.moduleicon)
	     		#set($moduleicon = $module.moduleicon)
	     	#end
	     	#set($entityurl = "$siteroot$apphome/views/modules/$module.id/entity.html")
			<a href="$entityurl" class="ajax" data-targetdivinner="applicationmaincontent" data-oemaxlevel="1" title="$module.getName()">
			<img src="$siteroot$apphome/theme/images/entity/${moduleicon}.svg" style="height: 24px;"> 
			
			#if( $idhits.size() < 7) ##this is safe
				#set( $count = $idhits.size())
			#else
				#set( $count = $filter.getCount($module.id) )
			#end
	
			$module.getName() <span class="count">($count)</span>
			</a>
		</h3>
		
   		</div>
		<div id="galleryimg-${rendertype}" 
				class='emgrid #if($section != "favorites")emgridlimited#end entitiescontainer' 
				data-colwidth="300" 
				data-cellpadding="25"
				data-entityrenderurl="$siteroot$apphome/components/gridsample/gridcell.html">
			#foreach( $hit in $idhits)
				$context.putPageValue("hit", $hit)
			    $pages.include("$apphome/components/gridsample/gridcell.html", $context)
			#end
		</div>
		
		#if( $filter.getCount($module.id) > 7)
			<a href="$entityurl" class="ajax entity-seemore" data-targetdivinner="applicationmaincontent" data-oemaxlevel="2" title="[[See More]] $module.getName()">[[See More]]</a>
		#end
		</div>		
	#end
		   
#end

