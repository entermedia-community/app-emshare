#set( $id = $context.getRequestParameter("id"))
#set( $searchtype = $context.getRequestParameter("searchtype"))
#set( $searcher = $mediaarchive.getSearcher($searchtype) )
$context.putPageValue("searcher",$searcher)

#if(!$moduleid)
	#set($moduleid = $context.getRequestParameter("moduleid"))
#end

#if($id)

#if( !$data)
	#set( $data  = $mediaarchive.getData($searchtype, $id) )
#end
$context.putPageValue("data",$data)

<div id="editentitymetadata">

#set($edit = $context.getRequestParameter("edit"))
#if($edit!="true")
	#set($edit="false")
#end

#set($viewid = "${searchtype}generalmetadata")
#set($view = "$searchtype/$viewid")

#set($action = "$siteroot$applink/components/gridsample/preview/metadata-save.html")

<form id="entitydataeditor" 
		name="entitydataeditor" 
		class="ajaxform force-validate-inputs" 
		data-targetdiv="editentitymetadata" 
		data-onsuccess="updateentities"
		method="post"  
		action="$action"
		enctype="multipart/form-data">
    	<input name="save" type="hidden" value="true" />
    	<input name="id" type="hidden" value="$!id" />
    	<input name="searchtype" type="hidden" value="$searchtype" />
    	<input name="moduleid" type="hidden" value="$moduleid" />
    	<input name="viewid" type="hidden" value="$viewid" />
    	<input name="view" type="hidden" value="$view" />
    	<input name="hitssessionid" type="hidden" value="$!hits.sessionId" />

    	
    	$context.putPageValue("view", $view)
    	$context.putPageValue("viewid", $viewid)
    	
		#if($edit =="true")  ##TODO - Permissions
			##1 or 2 colums feature
			#set($detailviewercolumns = $context.getRequestParameter("detailviewercolumns"))
			#if(!$detailviewercolumns)
				#set($detailviewercolumns = 2)
			#end
		
			$pages.include("/$applicationid/components/xml/detaileditor-entities.html?longform=true&detailviewercolumns=$detailviewercolumns", $context)
		#else
			##Tags search link
			$context.putPageValue("tagssearchlink", "$siteroot$apphome/views/modules/modulesearch/index.html")
		
			$pages.include("/$applicationid/components/xml/detaileditor-entities.html?detailsreadonly=true&alwaysshow=true", $context)
		#end
	
    #if($edit=="true")
    <div class="btns">
	    <a class="btn btn-sm btn-dark submitform" style="margin-right: 10px;">[[Save]]</a>
		<a class="btn btn-sm btn-dark ajax" style="margin-right: 10px;" data-targetdiv="editentitymetadata" href="$siteroot$apphome/components/gridsample/preview/metadata.html?id=$!id&searchtype=$!searchtype&moduleid=$!moduleid">[[Cancel]]</a>
		
		#if($detailviewercolumns==1)
			#set($changedetailviewercolumns = 2)
			#set($icondetailviewercolumns = "grip-vertical")
		#else
			#set($changedetailviewercolumns = 1)
			#set($icondetailviewercolumns = "grip-horizontal")
		#end
		<a class="ajax btn btn-sm btn-darkless float-right" data-targetdiv="applicationcontent" data-updateurl="true" data-closedialog="true" data-oemaxlayout="2" href="$siteroot$apphome/views/settings/modules/${searcher.searchType}/metadata/views/index.html?viewid=$viewid&viewpath=$!view&moduleid=$!moduleid"><i class="fas fa-cog"></i> [[Fields]]</a>
		<a class="ajax btn btn-sm btn-darkless float-right" style="margin-right:5px;" data-targetdiv="editentitymetadata" href="$siteroot$apphome/components/gridsample/preview/metadata.html?edit=true&id=$data.id&searchtype=$searchtype&detailviewercolumns=$changedetailviewercolumns&moduleid=$!moduleid">
			<i class="fas fa-$icondetailviewercolumns"></i>
		</a>
		
	    <div class="clearfix"></div>
    </div>
    #end
    </form>

#if($edit!="true")
<a href="$siteroot$apphome/components/gridsample/preview/metadata.html?edit=true&id=$data.id&searchtype=$searchtype&moduleid=$!moduleid" data-targetdiv="editentitymetadata" class="ajax btn btn-dark"><i class="fas fa-edit"></i> [[Edit]]</a>
<a href="$siteroot$apphome/components/entities/delete.html?id=$data.id&searchtype=$searchtype" class="ajax btn btn-dark" data-targetdiv="editentitymetadata" data-closedialog="true" data-confirm="[[Are you sure]]?" style="margin-left:10px;"><i class="fas fa-trash"></i> [[Delete]]</a>
#end

#if($edit && $edit !="true" && $moduleid) 
	##SUB-Views
	
	#set($viewsearcher = $searcherManager.getSearcher($catalogid, "view"))
	#set($views = $viewsearcher.query().exact("moduleid",$moduleid).exact("systemdefined","false").not("id",$viewid).sort("orderingUp").search($context) )
	#if($views)		
		#foreach( $targetview in $views)
			#set( $targetviewid = $targetview.getId())
			#set( $targetviewpath = "${searchtype}/"+$targetview.getId())
			#set( $viewdata = $viewsearcher.searchById($targetviewid))
			
			#set( $searchtype = $viewdata.rendertable )
			#set( $fieldexternalid = $viewdata.renderexternalid)
			#set( $fieldexternalvalue = $id )
			
			#set( $permissionname = "canedit${searchtype}")
			#set( $parentid = $context.getRequestParameter("parentid"))
			
			
			#set($targetmodule = $mediaarchive.getCachedData("module", $viewdata.rendertable)) 
			#set($targetrendertype = $targetmodule.modulerendertype)
			#if(!$targetrendertype)
				#set($targetrendertype = "entity")
			#end
	
			#set( $args = "id=$id&candelete=$!candelete&editpath=$!editpath&parentid=$!parentid&catalogid=$!catalogid&searchtype=$!searchtype&fieldexternalid=$!fieldexternalid&fieldexternalvalue=$!fieldexternalvalue&viewid=$!targetviewid&viewpath=$!targetviewpath&permissionname=$!permissionname&hitssessionid=$!hitssessionid")
			#set( $args = "$args&tabletype=subentity&targetrendertype=$!targetrendertype&targetdiv=entitypreviewdialog&targetoemaxlevel=1")
			
			
			<h3>$targetview</h3>
			$pages.include("/$applicationid/components/xml/table.html?$args&passalong=$!passalong",$context)
		#end
	#end

#end


</div>

#end