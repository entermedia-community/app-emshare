#set( $searchtype = $context.findValue("searchtype"))
#set( $parentsearchtype = $searchtype)
#set( $id = $context.getRequestParameter("id"))
#set( $addnew = $context.getRequestParameter("addnew"))
#ifnull($id)
	#set( $id = $context.getRequestParameter("entityid"))
	$context.putPageValue("id", $id)
#end

#if($id.startsWith("multiedit"))

#else
	#if( !$entity)
		#set( $entity  = $mediaarchive.getData($searchtype, $id) )
	#end
	#set($entityid = $entity.id)
	$context.putPageValue("entity", $entity)
	$context.putPageValue("entityid", $entityid)
#end

#set($module = $mediaarchive.getData("module", $searchtype))
#set($moduleid = $module.getId())
$context.putPageValue("moduleid", $moduleid)
$context.putPageValue("topmoduleid", $moduleid)

#set($viewsearcher = $searcherManager.getSearcher($catalogid, "view"))
#set($enttiyviews = $viewsearcher.query().exact("moduleid", $moduleid).exact("rendertype","table").exact("systemdefined","false").sort("orderingUp").search($context) )

#set($defaulttab = "tab_metadata")
#set( $entitytabopen = $context.getRequestParameter("entitytabopen"))

#ifnull($entitytabopen)
	#set( $entitytabopen = $userprofile.get("entitytabopen"))
#end

#if($entitytabopen.equals("undefined"))
	#set( $entitytabopen = $defaulttab)
#end

##default to General tab if not media allowed
#if($entitytabopen == 'tab_media')
	#if(!$module.getBoolean("enableuploading") || !$permissions.can($moduleid, "upload_files"))
		#set($entitytabopen = $defaulttab)
	#end
#end

##default to $defaulttab if not submodules (view) exists in this Entity
#if($entitytabopen.startsWith("tabsubentity_"))
	#if($enttiyviews)
		#foreach( $targetview in $enttiyviews)
			#set( $targetviewid = $targetview.getId())
			#set($tabid = "tabsubentity_$!{targetviewid}")
			#if($entitytabopen.equals($tabid))
				#set($foundtab = $tabid)
			#end
		#end
	#end
	#if($foundtab)
		#set($entitytabopen = $foundtab)
	#else
		#set($entitytabopen = $defaulttab)
	#end
#end


#set( $enablebackbutton = $context.getRequestParameter("enablebackbutton"))
#if ($addnew)
	#set($dialogtabid = "addnew${moduleid}")
#else
	#set($dialogtabid = "${moduleid}$!{entityid}")
#end
<div class="entitydialog #if($enablebackbutton || $addnew) enablebackbtn #end"
	id="#eid($!dialogtabid)" 
	data-moduleid="$moduleid" 
	data-entityid="$!entityid" 
	data-oemaxlevel="1"
	data-url="$componenthome/gridsample/preview/entity.html">
	
	<div class="entityclose largeicon"><span title="[[Esc to Close]]" class="fas fa-window-close"></span></div>
	
	<div class="entity-wraper">
	<h2>
	<a href="#" id="backbtn#eid($!dialogtabid)" class="entitydialogback" style="display: none;">
	<i class="fas fa-arrow-left"></i></a>
	#text($module) \ 
	
	#if($entity.getName($context))
			#set($name = $!entity.getName($context))
	#else 
		#if($addnew=='true')
			#set($name = "[[Add New]]")
			#set($entitytabopen = "tab_metadata")
			$context.putPageValue("addnew", $addnew)
		#end
	#end
	
	#text($name)
	
	</h2>
		
		<nav>
	  	<div class="nav nav-tabs entity-navigation" id="entity-nav-tab" role="tablist" 
	  		 data-tabmenuurl="gridsample/preview/entitytabmenu.html">
	  		##General Tab (tab_metadata)
	  		$context.putPageValue("tabmodule", $module)
	  		#set($tabid = "tab_metadata")
				#set($tabtype= "metadata")
				$context.putPageValue("tabtype", $tabtype)
			
			#if(!$entitytabopen || $entitytabopen == $tabid)
	  			$context.putPageValue("currenttab", $tabid)
			#end
			
			$pages.include("$componenthome/gridsample/preview/entitytabmenu.html", $context)
			
			#ifnotnull($id)
				
				##submodules
				#if($enttiyviews)		
					#foreach( $targetview in $enttiyviews)
						#set( $targetviewid = $targetview.getId())
						#set( $viewdata = $viewsearcher.searchById($targetviewid))
						#set( $subentitysearchtype = $viewdata.rendertable )
						#ifnotnull($subentitysearchtype)
							#set($submodule = $mediaarchive.getCachedData("module", $viewdata.rendertable))
							$context.putPageValue("tabmodule", $submodule)
							$context.putPageValue("tabtype", "submodulehome")
							$context.putPageValue("targetviewid", $targetviewid)
							
							#set($tabid = "tabsubentity_$!{targetviewid}")
							#set($tabtype= "submodulehome")
							#if($entitytabopen.equals($tabid))
					  			$context.putPageValue("currenttab", $tabid)
							#end
							#set($subcomponenthome = "$apphome/views/modules/$subentitysearchtype/components")
							$pages.include("$subcomponenthome/gridsample/preview/entitytabmenu.html", $context)
						#end
					#end
				#end	
				
				##media
				#if($module.getBoolean("enableuploading") && $permissions.can($moduleid, "upload_files"))
					#set($submodule = $mediaarchive.getCachedData("module", "asset"))
					$context.putPageValue("tabmodule", $submodule)
					$context.putPageValue("tabtype", "media")
					#set($tabid = "tab_media")
					$context.putPageValue("tabid", $tabid)
					#if($entitytabopen == $tabid)
			  			$context.putPageValue("currenttab", $tabid)
					#end
					#set($subcomponenthome = "$apphome/views/modules/asset/components")
					$pages.include("$subcomponenthome/gridsample/preview/entitytabmenu.html", $context)
				#end
			#end	
		</div>
		</nav>
		
		<div class="tab-content entity-body" id="entity-nav-tabContent">
				#set($tabtype= "metadata")
				$context.putPageValue("tabtype", $tabtype)
				$pages.include("$componenthome/gridsample/preview/entitytab.html", $context)
				
				#ifnotnull($id)
					##submodules
					#if($enttiyviews)		
						#foreach( $targetview in $enttiyviews)
							#set( $viewid = $targetview.getId())
							$context.putPageValue("viewid", $viewid)
							$context.putPageValue("parentsearchtype", $parentsearchtype)
							$context.putPageValue("parentid", $id)
							$context.putPageValue("hidesubmodule", true)
							
							#set($tabtype= "submodulehome")
							#if($entitytabopen == $tabtype)
					  			$context.putPageValue("currenttab", $tabtype)
					  		#end
							#set($subcomponenthome = "$apphome/views/modules/$subentitysearchtype/components")
							$pages.include("$subcomponenthome/gridsample/preview/entitytabsub.html", $context)
						#end
					#end
						
					#if($module.getBoolean("enableuploading") && $permissions.can($moduleid, "upload_files"))
						$context.putPageValue("parentsearchtype", $parentsearchtype)
						$context.putPageValue("hidesubmodule", true)
						#set($tabtype= "media")
						#if($entitytabopen == $tabtype)
				  			$context.putPageValue("currenttab", $tabtype)
				  		#end
						$pages.include("$subcomponenthome/gridsample/preview/entitytabmedia.html?entityid=$id", $context)
					#end
			#end
		</div>
	</div>
</div>


