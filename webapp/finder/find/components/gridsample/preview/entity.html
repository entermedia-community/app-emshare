#set( $searchtype = $context.findValue("searchtype"))
#set( $parentsearchtype = $searchtype)
#set( $id = $context.getRequestParameter("id"))
#set( $addnew = $context.getRequestParameter("addnew"))
#ifnull($id)
	#set( $id = $context.getRequestParameter("entityid"))
	$context.putPageValue("id", $id)
#end

#if($id.startsWith("multiedit"))

#else
	#if( !$entity)
		#set( $entity  = $mediaarchive.getData($searchtype, $id) )
	#end
	#set($entityid = $entity.id)
	$context.putPageValue("entity", $entity)
	$context.putPageValue("entityid", $entityid)
#end

#set($module = $mediaarchive.getData("module", $searchtype))
#set($moduleid = $module.getId())
$context.putPageValue("moduleid", $moduleid)
$context.putPageValue("topmoduleid", $moduleid)

#set($viewsearcher = $searcherManager.getSearcher($catalogid, "view"))
#set($enttiyviews = $viewsearcher.query().exact("moduleid", $moduleid).exact("systemdefined","false").sort("orderingUp").search($context) )


#set( $entitytabopen = $context.getRequestParameter("entitytabopen"))
#ifnull($entitytabopen)
	#set( $entitytabopen = $userprofile.get("${moduleid}_entitytabopen"))
	
#end


#if($entitytabopen.equals("undefined"))
	#set( $entitytabopen = "")
#end

##default to General tab if not media allowed
#if($entitytabopen == 'tab_media')
	#if(!$module.getBoolean("enableuploading") || !$permissions.can($moduleid, "upload_files"))
		#set($entitytabopen = "")
	#end
#end

##default to frist if not submodules (view) exists in this Entity
#if(!$entitytabopen && $enttiyviews)
	#foreach( $targetview in $enttiyviews)
		#set( $viewid = $targetview.getId())
		#set($tabid = "tab_$!{viewid}")
		#if($entitytabopen.equals($tabid))
			#set($foundtab = $tabid)
		#end
		#ifnull($firstview)
			#set($firstview = $viewid)
		#end
	#end
	#if($foundtab)
		#set($entitytabopen = $foundtab)
	#else
		#set($entitytabopen = "")
	#end
#end



#set( $enablebackbutton = $context.getRequestParameter("enablebackbutton"))
#if ($addnew)
	#foreach( $targetview in $enttiyviews)
		#set( $viewid = $targetview.getId())
		#ifnull($firstview)
			#set($firstview = $viewid)
		#end
	#end
	#set($dialogtabid = "addnew${moduleid}")
#else
	#set($dialogtabid = "${moduleid}$!{entityid}")
#end
<div class="entitydialog #if($enablebackbutton || $addnew) enablebackbtn #end"
	id="#eid($!dialogtabid)" 
	data-moduleid="$moduleid" 
	data-entityid="$!entityid" 
	data-oemaxlevel="1"
	data-url="$componenthome/gridsample/preview/entity.html">
	
	<div class="entityclose largeicon"><span title="[[Esc to Close]]" class="fas fa-window-close"></span></div>
	
	<div class="entity-wraper">
	<h2>
	<a href="#" id="backbtn#eid($!dialogtabid)" class="entitydialogback" style="display: none;">
	<i class="fas fa-arrow-left"></i></a>
	#text($module) \ 
	
	#if($entity.getName($context))
			#set($name = $!entity.getName($context))
	#else 
		#if($addnew=='true')
			#set($name = "[[Add New]]")
			
			$context.putPageValue("addnew", $addnew)
		#end
	#end
	
	#text($name)
	
	</h2>
		
		<nav>
	  	<div class="nav nav-tabs entity-navigation" id="entity-nav-tab" role="tablist" 
	  		 data-tabmenuurl="gridsample/preview/entitytabmenu.html">
			
			#ifnull($id)
			
				$context.putPageValue("viewid", $firstview)
				#set($entitytabopen = "tab_${firstview}")
				$context.putPageValue("currenttab", $entitytabopen)
				$pages.include("$componenthome/gridsample/preview/entitytabmenu.html", $context)
			#end
			#ifnotnull($id)
				#if($enttiyviews)		
					#foreach( $targetview in $enttiyviews)
						#set( $viewid = $targetview.getId())
						$context.putPageValue("viewid", $viewid)
						#set( $viewdata = $viewsearcher.searchById($viewid))
						$context.putPageValue("viewdata", $viewdata)
						
						#set($tabid = "tab_${viewid}")
						#if($entitytabopen.equals($tabid))
				  			$context.putPageValue("currenttab", $tabid)
						#end
						
						####One no many (Subentities)
						#if($targetview.rendertype=="table")
							#set( $subentitysearchtype = $viewdata.rendertable )
							#ifnotnull($subentitysearchtype)
								#set($submodule = $mediaarchive.getCachedData("module", $viewdata.rendertable))
								$context.putPageValue("tabmodule", $submodule)
								#set($tabtype= "submodulehome")
								$context.putPageValue("tabtype", $tabtype)
								#set($subcomponenthome = "$apphome/views/modules/$subentitysearchtype/components")
								$pages.include("$subcomponenthome/gridsample/preview/entitytabmenu.html", $context)
							#end
						#else
							####Metadata Tabs
					  		$context.putPageValue("tabmodule", $module)
					  		
							#set($tabtype= "metadata")
							$context.putPageValue("tabtype", $tabtype)
							
							#if(!$entitytabopen)
								#set($entitytabopen = $tabid)
					  			$context.putPageValue("currenttab", $tabid)
							#end
							
							$pages.include("$componenthome/gridsample/preview/entitytabmenu.html", $context)
						#end
					#end
				#end	
				
				##media
				#if($module.getBoolean("enableuploading") && $permissions.can($moduleid, "upload_files"))
					#set($submodule = $mediaarchive.getCachedData("module", "asset"))
					$context.putPageValue("tabmodule", $submodule)
					$context.putPageValue("tabtype", "media")
					#set($tabid = "tab_media")
					$context.putPageValue("tabid", $tabid)
					#if($entitytabopen == $tabid)
			  			$context.putPageValue("currenttab", $tabid)
					#end
					#set($subcomponenthome = "$apphome/views/modules/asset/components")
					$pages.include("$subcomponenthome/gridsample/preview/entitytabmenu.html", $context)
				#end
			#end	
		</div>
		</nav>
		
		<div class="tab-content entity-body" id="entity-nav-tabContent">

				#ifnull($id)
					$context.putPageValue("viewid", $firstview)
					#set($entitytabopen = "tab_${firstview}")
					$context.putPageValue("currenttab", $entitytabopen)
					$pages.include("$componenthome/gridsample/preview/entitytab.html", $context)
				#end
				#ifnotnull($id)
					##submodules
					#if($enttiyviews)		
						#foreach( $targetview in $enttiyviews)
							#set( $viewid = $targetview.getId())
							$context.putPageValue("viewid", $viewid)
							$context.putPageValue("parentsearchtype", $parentsearchtype)
							$context.putPageValue("parentid", $id)
							$context.putPageValue("hidesubmodule", true)
							
							#set($tabid = "tab_${viewid}")
							#if($entitytabopen.equals($tabid))
					  			$context.putPageValue("currenttab", $tabid)
							#end
							#if($targetview.rendertype=="table")
								#set($tabtype= "submodulehome")
								#set($subcomponenthome = "$apphome/views/modules/$subentitysearchtype/components")
								$pages.include("$subcomponenthome/gridsample/preview/entitytabsub.html", $context)
							#else
								#set($tabtype= "metadata")
								$context.putPageValue("tabtype", $tabtype)
								#if(!$entitytabopen)
									#set($entitytabopen = $tabid)
					  				$context.putPageValue("currenttab", $tabid)
								#end
								
								$pages.include("$componenthome/gridsample/preview/entitytab.html", $context)
							#end
						#end
					#end
						
					#if($module.getBoolean("enableuploading") && $permissions.can($moduleid, "upload_files"))
						$context.putPageValue("parentsearchtype", $parentsearchtype)
						$context.putPageValue("hidesubmodule", true)
						#set($tabtype= "media")
						#if($entitytabopen == $tabtype)
				  			$context.putPageValue("currenttab", $tabtype)
				  		#end
						$pages.include("$subcomponenthome/gridsample/preview/entitytabmedia.html?entityid=$id", $context)
					#end
			#end
		</div>
	</div>
</div>


